---
title: "PST Report"
author: "Generated by Wendy He"
date: "2024-12-13"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r library, include=FALSE, warning = FALSE}
# Load libraries
library(tidyr)
library(dplyr)
library(readxl)
library(tidyverse)
library(viridis)
library(lubridate)
library(gt)
library(knitr)
library(kableExtra)
library(VennDiagram)

setwd("/Users/wendyyy/Documents/CHAMPS_Epi Work/Original Code")
AnalyticData <- read.csv("vw_lk_Analytics_Dataset_2024-09-18_12-12-47.csv", stringsAsFactors=FALSE, na.strings=c("",".","NA"))
TacData <- read.csv("vw_lk_TacLaboratoryResult_Pivot_2024-09-17_14-22-48.csv", stringsAsFactors=FALSE, na.strings=c("",".","NA"))
```

```{r filter, include=FALSE, warning = FALSE}
AnalyticData <-AnalyticData %>%
  filter(MITS_flag==1) %>%
  filter(publication_suspended!=1 & !is.na(publication_suspended)) %>%
  filter(sensitive_case!=1 & !is.na(sensitive_case)) %>%
  filter(M00060==1) %>%
  filter(site_name != "Nigeria")
```

```{r New_Age, include=FALSE, warning = FALSE}
# To split the infant age group, here is the steps:
# Filter the data for the CH00718(infant) age group.
# Calculate the age of each infant in days from calc_dob to calc_dod.
# Split the filtered data into two subgroups: infants aged 28 days to less than 6 months and those aged 6 months to less than 12 months.

# Convert calc_dob and calc_dod to Date format
AnalyticData$calc_dob <- as.Date(AnalyticData$calc_dob, format="%m/%d/%y")
AnalyticData$calc_dod <- as.Date(AnalyticData$calc_dod, format="%m/%d/%y")

head(AnalyticData$calc_dob)
head(AnalyticData$calc_dod) 


AnalyticData <- AnalyticData %>%
  mutate(age_in_days = as.numeric(difftime(calc_dod, calc_dob, units = "days")),
         
         # Create infant subgroup for age group CH00718
         infant_subgroup = case_when(
           age_group == "CH00718" & age_in_days >= 28 & age_in_days < 182 ~ "28 days to <6 months",
           age_group == "CH00718" & age_in_days >= 182 & age_in_days < 365 ~ "6 months to <12 months",
           TRUE ~ NA_character_
         ),
         
         # Create early neonate subgroup for age group CH01405
         early_neonate_subgroup = case_when(
           age_group == "CH01405" & age_in_days >= 1 & age_in_days < 3 ~ "1 day to <3 days",
           age_group == "CH01405" & age_in_days >= 3 & age_in_days < 6 ~ "3 days to <6 days",
           TRUE ~ NA_character_
         ))

table(AnalyticData$infant_subgroup)
table(AnalyticData$early_neonate_subgroup)

```

```{r Staph, include=FALSE, warning = FALSE}
##### Task 2 #####

###### Then look at Staphylococcus aureus in different age group ######

vars_eti<-c("Underlying_Cause_Factor_etiol1","Underlying_Cause_Factor_etiol1_othr","Underlying_Cause_Factor_etiol2","Underlying_Cause_Factor_etiol2_othr",
            "Underlying_Cause_Factor_etiol3","Underlying_Cause_Factor_etiol3_othr","Immediate_Cause_of_Death_etiol1","Immediate_Cause_of_Death_etiol1_othr",
            "Immediate_Cause_of_Death_etiol2","Immediate_Cause_of_Death_etiol2_othr","Immediate_Cause_of_Death_etiol3","Immediate_Cause_of_Death_etiol3_othr",
            "Morbid_Condition_01_etiol1","Morbid_Condition_01_etiol1_othr","Morbid_Condition_01_etiol2","Morbid_Condition_01_etiol2_othr",
            "Morbid_Condition_01_etiol3","Morbid_Condition_01_etiol3_othr","Morbid_Condition_02_etiol1","Morbid_Condition_02_etiol1_othr",     
            "Morbid_Condition_02_etiol2","Morbid_Condition_02_etiol2_othr","Morbid_Condition_02_etiol3","Morbid_Condition_02_etiol3_othr",
            "Morbid_Condition_03_etiol1","Morbid_Condition_03_etiol1_othr","Morbid_Condition_03_etiol2","Morbid_Condition_03_etiol2_othr",
            "Morbid_Condition_03_etiol3","Morbid_Condition_03_etiol3_othr","Morbid_Condition_04_etiol1","Morbid_Condition_04_etiol1_othr",
            "Morbid_Condition_04_etiol2","Morbid_Condition_04_etiol2_othr","Morbid_Condition_04_etiol3","Morbid_Condition_04_etiol3_othr",
            "Morbid_Condition_05_etiol1","Morbid_Condition_05_etiol1_othr","Morbid_Condition_05_etiol2","Morbid_Condition_05_etiol2_othr",
            "Morbid_Condition_05_etiol3","Morbid_Condition_05_etiol3_othr","Morbid_Condition_06_etiol1","Morbid_Condition_06_etiol1_othr",
            "Morbid_Condition_06_etiol2","Morbid_Condition_06_etiol2_othr","Morbid_Condition_06_etiol3","Morbid_Condition_06_etiol3_othr",
            "Morbid_Condition_07_etiol1","Morbid_Condition_07_etiol1_othr","Morbid_Condition_07_etiol2","Morbid_Condition_07_etiol2_othr",
            "Morbid_Condition_07_etiol3","Morbid_Condition_07_etiol3_othr","Morbid_Condition_08_etiol1","Morbid_Condition_08_etiol1_othr",
            "Morbid_Condition_08_etiol2","Morbid_Condition_08_etiol2_othr","Morbid_Condition_08_etiol3","Morbid_Condition_08_etiol3_othr") 

countries_of_interest <- c("Bangladesh", "Ethiopia", "Kenya", "Mali", "Mozambique", "Sierra Leone", "South Africa")

staph_cases <- AnalyticData %>%
  filter(apply(AnalyticData[vars_eti], 1, function(row) any(grepl("Staphylococcus aureus", row, ignore.case = TRUE))))


# Calculate the total number of deaths for each age group from the original dataset
total_deaths_by_age <- AnalyticData %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n())  # Total number of deaths in each age group

print(total_deaths_by_age)

# Calculate the number of Staphylococcus aureus cases for each age group from the filtered staph_cases
staph_cases_by_age <- staph_cases %>%
  group_by(age_group) %>%
  summarise(Staph_Cases = n())  # Count of Staphylococcus aureus cases in each age group

print(staph_cases_by_age)

# Merge both summaries to calculate the percentage of Staphylococcus aureus deaths
age_group_summary <- left_join(total_deaths_by_age, staph_cases_by_age, by = "age_group") %>%
  mutate(
    Staph_Cases = replace_na(Staph_Cases, 0),  # Replace NA with 0
    Percentage_Staph = (Staph_Cases / Total_Deaths) * 100  # Calculate the percentage
  )

# Print the final summary table
age_group_summary %>%
  kable(
    caption = "Summary of Staphylococcus aureus Deaths by Age Group",
    col.names = c("Age Group", "Total Deaths", "Staph Cases", "Percentage Staph Deaths (%)"),
    align = "c"
  ) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  row_spec(0, background = "lightgreen") %>%     # Header row in light green
  row_spec(1:nrow(age_group_summary), background = "honeydew") # All rows with a soft green background


# CH00716 Stillbirth
# CH00718 Infant (28 days to less than 12 months)
# CH00719 Child (12 months to less than 60 Months)
# CH01404	Death in the first 24 hours
# CH01405	Early Neonate (1 to 6 days)
# CH01406	Late Neonate (7 to 27 days) 

```

## ***Staphylococcus aureus***

```{r Staph_Death, include=FALSE}

#### Task 3 #####

AnalyticData <- AnalyticData %>%
  mutate(
    age_group = case_when(
      age_group == "CH00716" ~ "Stillbirth",
      age_group == "CH00718" ~ "Infant (28 days to less than 12 months)",
      age_group == "CH00719" ~ "Child (12 months to less than 60 months)",
      age_group == "CH01404" ~ "Death in the first 24 hours",
      age_group == "CH01405" ~ "Early Neonate (1 to 6 days)",
      age_group == "CH01406" ~ "Late Neonate (7 to 27 days)",
      TRUE ~ age_group # Retain original value for unmatched cases
    )
  )


# Filter Staphylococcus aureus cases in the causal chain
staph_cases_ch <- AnalyticData %>%
  filter(apply(AnalyticData[vars_eti], 1, function(row) any(grepl("Staphylococcus aureus", row, ignore.case = TRUE))))

# Calculate the total number of deaths for each age group
total_deaths_by_age <- AnalyticData %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n(), .groups = 'drop')

# Calculate the number of Staphylococcus aureus cases (causal chain) for each age group
staph_cases_by_age <- staph_cases_ch %>%
  group_by(age_group) %>%
  summarise(Staph_Cases_ch = n(), .groups = 'drop')

# Process TacData for detected S. aureus deaths
# Rename and join TacData with age groups
TacData <- TacData %>%
  rename(Champsid = ChampsID)

Tac_filtered <- TacData %>%
  filter(Champsid %in% AnalyticData$Champsid) %>%
  left_join(select(AnalyticData, Champsid, age_group), by = "Champsid") %>%
  mutate(
    S_aureus_detected = ifelse(bld_STAU_2 == "Positive" | CSF_STAU_2 == "Positive" | lung_STAU_2 == "Positive", 1, 0))

# Summarize detected S. aureus deaths by age group
s_aureus_detected <- Tac_filtered %>%
  group_by(age_group) %>%
  summarise(S_aureus_Detected_Deaths = sum(S_aureus_detected, na.rm = TRUE), .groups = 'drop')

# Merge summaries and calculate percentages
age_group_summary <- total_deaths_by_age %>%
  left_join(staph_cases_by_age, by = "age_group") %>%
  left_join(s_aureus_detected, by = "age_group") %>%
  mutate(
    Staph_Cases_ch = replace_na(Staph_Cases_ch, 0),
    S_aureus_Detected_Deaths = replace_na(S_aureus_Detected_Deaths, 0),
    Percentage_Staph = (Staph_Cases_ch / Total_Deaths) * 100
  )

# Combine Staph Cases and Percentages into a single column
age_group_summary <- age_group_summary %>%
  mutate(
    S_aureus_Cases_Combined = paste0(
      Staph_Cases_ch, " (", round(Percentage_Staph, 2), "%)"
    )
  ) %>%
  select(
    age_group,
    Total_Deaths,
    S_aureus_Detected_Deaths,
    S_aureus_Cases_Combined
  )

# Arrange by age group order
age_group_summary <- age_group_summary %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Stillbirth",
        "Death in the first 24 hours",
        "Early Neonate (1 to 6 days)",
        "Late Neonate (7 to 27 days)",
        "Infant (28 days to less than 12 months)",
        "Child (12 months to less than 60 months)"
      )
    )
  ) %>%
  arrange(age_group)

# Calculate the total row
total_row <- age_group_summary %>%
  summarise(
    age_group = "Total",  # Label the total row
    Total_Deaths = sum(Total_Deaths, na.rm = TRUE),
    S_aureus_Detected_Deaths = sum(S_aureus_Detected_Deaths, na.rm = TRUE),
    S_aureus_Cases_Combined = paste0(
      sum(as.numeric(str_extract(S_aureus_Cases_Combined, "^[0-9]+")), na.rm = TRUE), 
      " (",
      round(sum(as.numeric(str_extract(S_aureus_Cases_Combined, "(?<=\\().+(?=%\\))")), na.rm = TRUE) / nrow(age_group_summary), 2), 
      "%)"
    )
  )


final_summary <- bind_rows(age_group_summary, total_row)



```

```{r Staph_Death_graph, echo=FALSE}
# Final table with the total row
final_summary %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *S. aureus* Deaths by Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Total_Deaths = "Total Deaths",
    S_aureus_Detected_Deaths = md("*S. aureus* Detected Deaths"),
    S_aureus_Cases_Combined = md("*S. aureus* Cases (Causal Chain) %")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body(rows = nrow(final_summary))  # Highlight the total row
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )
```

```{r Task4, include=FALSE, warning = FALSE}
### Final Task 4 ###


# Define updated country columns and their populations
location_data <- tibble(
  Location = c("Bangladesh", "Ethiopia", "Kenya", "Mali", "Mozambique", "Sierra Leone", "South Africa"),
  Total_People = c(804, 925, 911, 599, 1338, 911, 1279)
)

# Define updated age group and total deaths
age_group_data <- tibble(
  age_group = c("CH00716", "CH00718", "CH00719", "CH01404", "CH01405", "CH01406"),
  Total_Deaths = c(2567, 835, 770, 1018, 1114, 463)
)

# Map age group labels for readability
age_group_labels <- c(
  "CH00716" = "Stillbirth (n=2567)",
  "CH00718" = "Infant (28 days to less than 12 months) (n=835)",
  "CH00719" = "Child (12 months to less than 60 months) (n=770)",
  "CH01404" = "Death in the first 24 hours (n=1018)",
  "CH01405" = "Early Neonate (1 to 6 days) (n=1114)",
  "CH01406" = "Late Neonate (7 to 27 days) (n=463)"
)

# Create the main table for display
country_columns <- location_data$Location

# Filter Staphylococcus aureus cases and summarize
staph_cases <- AnalyticData %>%
  select(site_name, age_group) %>%
  filter(apply(AnalyticData[vars_eti], 1, function(row) any(grepl("Staphylococcus aureus", row, ignore.case = TRUE)))) %>%
  group_by(site_name, age_group) %>%
  summarise(Staph_Cases = n(), .groups = 'drop')

# Reshape the data so that locations become columns
staph_table <- staph_cases %>%
  pivot_wider(names_from = site_name, values_from = Staph_Cases, values_fill = list(Staph_Cases = 0))

# Add readable age group labels
#staph_table <- staph_table %>%
#mutate(age_group = recode(age_group, !!!age_group_labels))



# Add total cases column for each row
staph_table <- staph_table %>%
  rowwise() %>%
  mutate(Total_cases = sum(c_across(all_of(country_columns)), na.rm = TRUE)) %>%
  ungroup()

# Calculate totals for each column
site_totals <- staph_table %>%
  summarise(across(all_of(country_columns), ~ sum(.x, na.rm = TRUE)))

# Prepare TOTAL row with column totals and formatted percentages
total_row <- site_totals %>%
  mutate(
    age_group = "TOTAL",
    Row_Total_Percentage = paste0(
      sum(as.numeric(unlist(site_totals)), na.rm = TRUE), # Total cases
      " (",
      round(sum(as.numeric(unlist(site_totals)), na.rm = TRUE) / sum(location_data$Total_People) * 100, 1),
      "%)"
    )
  )

for (i in seq_along(country_columns)) {
  site_total <- as.numeric(total_row[[country_columns[i]]])
  population <- location_data %>% filter(Location == country_columns[i]) %>% pull(Total_People)
  total_row[[country_columns[i]]] <- paste0(site_total, " (", round((site_total / population) * 100, 1), "%)")
}

# Calculate row total percentage for each age group
staph_table <- staph_table %>%
  rowwise() %>%
  mutate(
    Row_Total_Percentage = ifelse(
      Total_cases > 0,
      paste0(
        Total_cases,
        " (",
        round((Total_cases / sum(location_data$Total_People)) * 100, 1),
        "%)"
      ),
      NA
    )
  ) %>%
  ungroup()

# Convert all numeric columns in staph_table to character for compatibility
staph_table <- staph_table %>%
  mutate(across(all_of(country_columns), as.character))

# Append TOTAL row to the table
final_table <- staph_table %>%
  bind_rows(total_row)

# Reorder rows based on desired age group order
age_group_order <- c(
  "Stillbirth (n=2567)",
  "Death in the first 24 hours (n=1018)",
  "Early Neonate (1 to 6 days) (n=1114)",
  "Late Neonate (7 to 27 days) (n=463)",
  "Infant (28 days to less than 12 months) (n=835)",
  "Child (12 months to less than 60 months) (n=770)",
  "TOTAL"
)

final_table <- final_table %>%
  mutate(age_group = factor(age_group, levels = age_group_order)) %>%
  arrange(age_group)

# Preserve "Row Total Percentage"
final_table <- final_table %>%
  select(age_group, all_of(country_columns), Row_Total_Percentage)





```


```{r Staph_Loca_age_loca, echo=FALSE}

final_table %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *S.aureus* in Causal Chain by Location and Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Bangladesh = "Bangladesh (n=804)",
    Ethiopia = "Ethiopia (n=925)",
    Kenya = "Kenya (n=911)",
    Mali = "Mali (n=599)",
    Mozambique = "Mozambique (n=1338)",
    `Sierra Leone` = "Sierra Leone (n=911)",
    `South Africa` = "South Africa (n=1279)",
    Row_Total_Percentage = "Row Total Percentage"
  ) %>%
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )

```








## ***Klebsiella Pneumoniae***

```{r KP_age, include=FALSE}
### Updated for Klebsiella pneumoniae ###

# Define mapping for age groups
age_group_mapping <- c(
  "CH00716" = "Stillbirth",
  "CH00718" = "Infant (28 days to less than 12 months)",
  "CH00719" = "Child (12 months to less than 60 months)",
  "CH01404" = "Death in the first 24 hours",
  "CH01405" = "Early Neonate (1 to 6 days)",
  "CH01406" = "Late Neonate (7 to 27 days)"
)

# Apply the mapping to age_group in AnalyticData
AnalyticData <- AnalyticData %>%
  mutate(
    age_group = recode(age_group, !!!age_group_mapping))

# Filter Klebsiella pneumoniae cases in the causal chain
kp_cases_ch <- AnalyticData %>%
  filter(apply(AnalyticData[vars_eti], 1, function(row) any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE))))

# Calculate the total number of deaths for each age group
total_deaths_by_age <- AnalyticData %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n(), .groups = 'drop')

# Calculate the number of Klebsiella pneumoniae cases (causal chain) for each age group
kp_cases_by_age <- kp_cases_ch %>%
  group_by(age_group) %>%
  summarise(KP_Cases_ch = n(), .groups = 'drop')

# Process TacData for detected Klebsiella pneumoniae deaths
# Rename and join TacData with age groups
TacData <- TacData %>%
  rename(Champsid = Champsid)

Tac_filtered <- TacData %>%
  filter(Champsid %in% AnalyticData$Champsid) %>%
  left_join(select(AnalyticData, Champsid, age_group), by = "Champsid") %>%
  mutate(
    KP_detected = ifelse(bld_KLPN_1 == "Positive" | CSF_KLPN_1 == "Positive" | lung_KLPN_1 == "Positive", 1, 0))

# Summarize detected Klebsiella pneumoniae deaths by age group
kp_detected <- Tac_filtered %>%
  group_by(age_group) %>%
  summarise(KP_Detected_Deaths = sum(KP_detected, na.rm = TRUE), .groups = 'drop')

# Merge summaries and calculate percentages
age_group_summary <- total_deaths_by_age %>%
  left_join(kp_cases_by_age, by = "age_group") %>%
  left_join(kp_detected, by = "age_group") %>%
  mutate(
    KP_Cases_ch = replace_na(KP_Cases_ch, 0),
    KP_Detected_Deaths = replace_na(KP_Detected_Deaths, 0),
    Percentage_KP = (KP_Cases_ch / Total_Deaths) * 100
  )

# Combine Klebsiella pneumoniae Cases and Percentages into a single column
age_group_summary <- age_group_summary %>%
  mutate(
    KP_Cases_Combined = paste0(
      KP_Cases_ch, " (", round(Percentage_KP, 2), "%)"
    )
  ) %>%
  select(
    age_group,
    Total_Deaths,
    KP_Detected_Deaths,
    KP_Cases_Combined
  )

# Arrange by age group order
age_group_summary <- age_group_summary %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Stillbirth",
        "Death in the first 24 hours",
        "Early Neonate (1 to 6 days)",
        "Late Neonate (7 to 27 days)",
        "Infant (28 days to less than 12 months)",
        "Child (12 months to less than 60 months)"
      )
    )
  ) %>%
  arrange(age_group)

# Calculate the total row
total_row <- age_group_summary %>%
  summarise(
    age_group = "Total",  # Label the total row
    Total_Deaths = sum(Total_Deaths, na.rm = TRUE),
    KP_Detected_Deaths = sum(KP_Detected_Deaths, na.rm = TRUE),
    KP_Cases_Combined = paste0(
      sum(as.numeric(str_extract(KP_Cases_Combined, "^[0-9]+")), na.rm = TRUE), 
      " (",
      round(sum(as.numeric(str_extract(KP_Cases_Combined, "(?<=\\().+(?=%\\))")), na.rm = TRUE) / nrow(age_group_summary), 2), 
      "%)"
    )
  )

final_summary <- bind_rows(age_group_summary, total_row)


```

```{r KP_age_table, echo=FALSE}
# Final table with the total row
final_summary %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *K. pneumoniae* Deaths by Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Total_Deaths = "Total Deaths",
    KP_Detected_Deaths = md("*K. pneumoniae* Detected Deaths"),
    KP_Cases_Combined = md("*K. pneumoniae* Cases (Causal Chain) %")
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body(rows = nrow(final_summary))  # Highlight the total row
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```

```{r KP_loca_age, include=FALSE, warning = FALSE}
# Task 4 KP # 

# Define updated country columns and their populations
location_data <- tibble(
  Location = c("Bangladesh", "Ethiopia", "Kenya", "Mali", "Mozambique", "Sierra Leone", "South Africa"),
  Total_People = c(804, 925, 911, 599, 1338, 911, 1279)
)

# Define updated age group and total deaths
age_group_data <- tibble(
  age_group = c("CH00716", "CH00718", "CH00719", "CH01404", "CH01405", "CH01406"),
  Total_Deaths = c(2567, 835, 770, 1018, 1114, 463)
)

# Create and display the `Total_People` table
print("Total People per Location:")
location_data %>%
  gt() %>%
  tab_header(title = md("**Total People per Location**"))

# Create and display the `Total_Deaths` table
age_group_data <- age_group_data %>%
  mutate(
    age_group = recode(
      age_group,
      "CH00716" = "Stillbirth",
      "CH00718" = "Infant (28 days to less than 12 months)",
      "CH00719" = "Child (12 months to less than 60 months)",
      "CH01404" = "Death in the first 24 hours",
      "CH01405" = "Early Neonate (1 to 6 days)",
      "CH01406" = "Late Neonate (7 to 27 days)"
    )
  )

print("Total Deaths per Age Group:")
age_group_data %>%
  gt() %>%
  tab_header(title = md("**Total Deaths per Age Group**"))

# Create the main table for display
country_columns <- location_data$Location
kleb_cases <- AnalyticData %>%
  select(site_name, age_group) %>%
  filter(apply(AnalyticData[vars_eti], 1, function(row) any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE)))) %>%
  group_by(site_name, age_group) %>%
  summarise(Kleb_Cases = n(), .groups = 'drop')

# Reshape the data so that locations become columns
kleb_table <- kleb_cases %>%
  pivot_wider(names_from = site_name, values_from = Kleb_Cases, values_fill = list(Kleb_Cases = 0))

# Add readable age group labels
kleb_table <- kleb_table %>%
  mutate(age_group = recode(
    age_group,
    "CH00716" = "Stillbirth (n=2567)",
    "CH00718" = "Infant (28 days to less than 12 months) (n=835)",
    "CH00719" = "Child (12 months to less than 60 months) (n=770)",
    "CH01404" = "Death in the first 24 hours (n=1018)",
    "CH01405" = "Early Neonate (1 to 6 days) (n=1114)",
    "CH01406" = "Late Neonate (7 to 27 days) (n=463)"
  ))

# Add total cases column for each row
kleb_table <- kleb_table %>%
  rowwise() %>%
  mutate(Total_cases = sum(c_across(all_of(country_columns)), na.rm = TRUE)) %>%
  ungroup()

# Calculate totals for each column
site_totals <- kleb_table %>%
  summarise(across(all_of(country_columns), ~ sum(.x, na.rm = TRUE)))

# Prepare TOTAL row with column totals and formatted percentages
total_row <- site_totals %>%
  mutate(
    age_group = "TOTAL",
    Row_Total_Percentage = paste0(
      sum(as.numeric(unlist(site_totals)), na.rm = TRUE), # Total cases
      " (",
      round(sum(as.numeric(unlist(site_totals)), na.rm = TRUE) / sum(location_data$Total_People) * 100, 1),
      "%)"
    )
  )

for (i in seq_along(country_columns)) {
  site_total <- as.numeric(total_row[[country_columns[i]]])
  population <- location_data %>% filter(Location == country_columns[i]) %>% pull(Total_People)
  total_row[[country_columns[i]]] <- paste0(site_total, " (", round((site_total / population) * 100, 1), "%)")
}

# Calculate row total percentage for each age group
kleb_table <- kleb_table %>%
  rowwise() %>%
  mutate(
    Row_Total_Percentage = ifelse(
      Total_cases > 0,
      paste0(
        Total_cases,
        " (",
        round((Total_cases / sum(location_data$Total_People)) * 100, 1),
        "%)"
      ),
      NA
    )
  ) %>%
  ungroup()

# Convert all numeric columns in kleb_table to character for compatibility
kleb_table <- kleb_table %>%
  mutate(across(all_of(country_columns), as.character))

# Append TOTAL row to the table
final_table <- kleb_table %>%
  bind_rows(total_row)

# Reorder rows based on desired age group order
age_group_order <- c(
  "Stillbirth (n=2567)",
  "Death in the first 24 hours (n=1018)",
  "Early Neonate (1 to 6 days) (n=1114)",
  "Late Neonate (7 to 27 days) (n=463)",
  "Infant (28 days to less than 12 months) (n=835)",
  "Child (12 months to less than 60 months) (n=770)",
  "TOTAL"
)

final_table <- final_table %>%
  mutate(age_group = factor(age_group, levels = age_group_order)) %>%
  arrange(age_group)

# Preserve "Row Total Percentage"
final_table <- final_table %>%
  select(age_group, all_of(country_columns), Row_Total_Percentage)



```

```{r KP_Loca_Age_final, echo=FALSE, message=FALSE}
# Create the final table with gt
final_table %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *K.pneumoniae* in Causal Chain by Location and Age Group**")
  ) %>%
  cols_label(
    age_group = "Case Type",
    Bangladesh = "Bangladesh (n=804)",
    Ethiopia = "Ethiopia (n=925)",
    Kenya = "Kenya (n=911)",
    Mali = "Mali (n=599)",
    Mozambique = "Mozambique (n=1338)",
    `Sierra Leone` = "Sierra Leone (n=911)",
    `South Africa` = "South Africa (n=1279)",
    Row_Total_Percentage = "Row Total Percentage"
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )
```

```{r Month_old_variable, include=FALSE, warning = FALSE}
### Create table for KP death summary in 28days and 6 months by age in months

# Convert `calc_dob` and `calc_dod` to date format
AnalyticData <- AnalyticData %>%
  mutate(
    calc_dob = ymd(calc_dob),  # Convert calc_dob to date
    calc_dod = ymd(calc_dod)   # Convert calc_dod to date
  )

# Calculate age in days
AnalyticData <- AnalyticData %>%
  mutate(age_in_days = as.numeric(difftime(calc_dod, calc_dob, units = "days")))

# Create the `month_old` column
AnalyticData <- AnalyticData %>%
  mutate(
    month_old = case_when(
      case_type_calc == "CH00718" & age_in_days >= 28 & age_in_days < 60 ~ "28d to <2 months",
      case_type_calc == "CH00718" & age_in_days >= 60 & age_in_days < 90 ~ "2 to <3 months",
      case_type_calc == "CH00718" & age_in_days >= 90 & age_in_days < 120 ~ "3 to <4 months",
      case_type_calc == "CH00718" & age_in_days >= 120 & age_in_days < 150 ~ "4 to <5 months",
      case_type_calc == "CH00718" & age_in_days >= 150 & age_in_days < 180 ~ "5 to <6 months",
      TRUE ~ NA_character_  # Keep other age groups unchanged
    )
  )

# Filter or retain rows where `month_old` is not NA
AnalyticData <- AnalyticData %>%
  filter(!is.na(month_old))  # Keep only infant age groups split by month



print(AnalyticData$month_old)

```

```{r Month_old_table, include=FALSE, warning = FALSE}
#Calculate total number of people (n=) in each `month_old` group, excluding NAs
month_totals <- AnalyticData %>%
  filter(!is.na(month_old)) %>%  # Exclude NA values
  group_by(month_old) %>%
  summarise(Total_people = n()) %>%  # Count total people in each `month_old` group
  mutate(
    month_old = factor(month_old, levels = c(
      "28d to <2 months",  
      "2 to <3 months",    
      "3 to <4 months",
      "4 to <5 months",
      "5 to <6 months"
    ))
  )

print(month_totals)

#Filter Klebsiella pneumoniae cases in the causal chain, excluding NAs
kp_cases_ch <- AnalyticData %>%
  filter(!is.na(month_old)) %>%  # Exclude NA values
  filter(apply(select(., all_of(vars_eti)), 1, function(row) any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE)))) %>%
  group_by(month_old) %>%
  summarise(K_pneumoniae_ch = n()) %>%  # Summarize cases
  left_join(month_totals, by = "month_old") %>%  # Add total people per `month_old`
  mutate(
    Percent = round((K_pneumoniae_ch / Total_people) * 100, 1),  # Correct percentage calculation
    `K_pneumoniae_ch (%)` = paste0(K_pneumoniae_ch, " (", Percent, "%)")
  )

#Prepare TacData for analysis
TacData <- TacData %>%
  rename(Champsid = Champsid)  # Ensure column name matches

#Filter TacData for K. pneumoniae cases, merge with AnalyticData, and exclude NAs
TacData <- TacData %>%
  filter(Champsid %in% AnalyticData$Champsid) %>%  # Filter for matching Champsid
  left_join(select(AnalyticData, Champsid, month_old), by = "Champsid") %>%  # Merge with `month_old`
  filter(!is.na(month_old)) %>%  # Exclude NA values
  mutate(
    K_pneumoniae_detected = ifelse(
      bld_KLPN_1 == "Positive" | CSF_KLPN_1 == "Positive" | lung_KLPN_1 == "Positive", 1, 0  
    )
  )

#Summarize K. pneumoniae detected in TAC by month_old, excluding NAs
kp_tac_summary <- TacData %>%
  filter(K_pneumoniae_detected == 1) %>%  # Include only detected cases
  group_by(month_old) %>%
  summarise(K_pneumoniae_TAC = n()) %>%
  left_join(month_totals, by = "month_old") %>%  # Add total people per `month_old`
  mutate(
    TAC_Percent = round((K_pneumoniae_TAC / Total_people) * 100, 1),  
    `K_pneumoniae_in_TAC` = paste0(K_pneumoniae_TAC, " (", TAC_Percent, "%)")
  )

#Combine both tables, excluding NAs
kp_combined <- kp_tac_summary %>%
  left_join(kp_cases_ch, by = "month_old") %>%
  mutate(
    month_old_label = case_when(
      month_old == "28d to <2 months" ~ "28d to <2 months (n=178)",  
      month_old == "2 to <3 months" ~ "2 to <3 months (n=106)",      
      month_old == "3 to <4 months" ~ "3 to <4 months (n=82)",       
      month_old == "4 to <5 months" ~ "4 to <5 months (n=61)",       
      month_old == "5 to <6 months" ~ "5 to <6 months (n=73)"        
    )
  ) %>%
  arrange(factor(month_old, levels = c(
    "28d to <2 months",  
    "2 to <3 months",    
    "3 to <4 months",
    "4 to <5 months",
    "5 to <6 months"
  ))) %>%
  select(
    month_old_label,  # Use the manually labeled column
    `K_pneumoniae_in_TAC`,  
    `K_pneumoniae_ch (%)`
  ) %>%
  filter(!is.na(month_old_label))
```

```{r Month_old_final, echo=FALSE, message=FALSE}
# Display the final table

kp_combined %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *K. pneumoniae* in Causal Chain and TAC by Month Old**")
  ) %>%
  cols_label(
    month_old_label = "Month Old",
    `K_pneumoniae_ch (%)` = md("*K. pneumoniae* in Causal Chain (%)"),
    `K_pneumoniae_in_TAC` = md("*K. pneumoniae* in TAC (%)")
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )
```

```{r Check_up, include=FALSE}
unique_values_uc <- sort(unique(AnalyticData$UC_champs_group_desc))
unique_values_ic <- sort(unique(AnalyticData$IC_champs_group_desc))
table_uc <- table(AnalyticData$UC_champs_group_desc)
table_IC <- table(AnalyticData$IC_champs_group_desc)

print("Unique values in UC_champs_group_desc:")
print(unique_values_uc)
print("Table for UC_champs_group_desc:")
print(table_uc) 
print(table_IC)
```

```{r Symptoms, include=FALSE}


# Define Syndrome Groups
syndrome_mapping <- list(
  sepsis = c("sepsis", "Neonatal sepsis"),
  pneumonia = c("Lower respiratory infections"),
  meningitis = c("Meningitis/Encephalitis")
)

AnalyticData <- AnalyticData %>%
  filter(
    apply(select(., all_of(vars_eti)), 1, function(row) {
      any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE))
    })
  )

# Create Indicators for Each Syndrome in AnalyticData
AnalyticData <- AnalyticData %>%
  mutate(
    Sepsis_Causal_Chain = ifelse(
      grepl(paste(syndrome_mapping$sepsis, collapse = "|"), UC_champs_group_desc, ignore.case = TRUE) |
      grepl(paste(syndrome_mapping$sepsis, collapse = "|"), IC_champs_group_desc, ignore.case = TRUE) |
      apply(select(., starts_with("Morbid_Cond_")), 1, function(row) {
        any(grepl(paste(syndrome_mapping$sepsis, collapse = "|"), row, ignore.case = TRUE))
      }),
      1, 0
    ),
    Pneumonia_Causal_Chain = ifelse(
      grepl(paste(syndrome_mapping$pneumonia, collapse = "|"), UC_champs_group_desc, ignore.case = TRUE) |
      grepl(paste(syndrome_mapping$pneumonia, collapse = "|"), IC_champs_group_desc, ignore.case = TRUE) |
      apply(select(., starts_with("Morbid_Cond_")), 1, function(row) {
        any(grepl(paste(syndrome_mapping$pneumonia, collapse = "|"), row, ignore.case = TRUE))
      }),
      1, 0
    ),
    Meningitis_Causal_Chain = ifelse(
      grepl(paste(syndrome_mapping$meningitis, collapse = "|"), UC_champs_group_desc, ignore.case = TRUE) |
      grepl(paste(syndrome_mapping$meningitis, collapse = "|"), IC_champs_group_desc, ignore.case = TRUE) |
      apply(select(., starts_with("Morbid_Cond_")), 1, function(row) {
        any(grepl(paste(syndrome_mapping$meningitis, collapse = "|"), row, ignore.case = TRUE))
      }),
      1, 0
    )
  )

# Add Other Infections Indicator
AnalyticData <- AnalyticData %>%
  mutate(
    Other_Infections = ifelse(
      Sepsis_Causal_Chain == 0 & Pneumonia_Causal_Chain == 0 & Meningitis_Causal_Chain == 0, 1, 0
    )
  )

# Summarize Data
syndrome_summary <- AnalyticData %>%
  summarise(
    Total_Cases = n(),
    Sepsis_Cases = sum(Sepsis_Causal_Chain, na.rm = TRUE),
    Pneumonia_Cases = sum(Pneumonia_Causal_Chain, na.rm = TRUE),
    Meningitis_Cases = sum(Meningitis_Causal_Chain, na.rm = TRUE),
    Other_Infection_Cases = sum(Other_Infections, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = Sepsis_Cases:Other_Infection_Cases,
    names_to = "Syndrome",
    values_to = "Count"
  ) %>%
  mutate(
    Syndrome = case_when(
      Syndrome == "Sepsis_Cases" ~ "Sepsis",
      Syndrome == "Pneumonia_Cases" ~ "Pneumonia",
      Syndrome == "Meningitis_Cases" ~ "Meningitis",
      Syndrome == "Other_Infection_Cases" ~ "Other infection"
    ),
    Percentage = round((Count / Total_Cases) * 100, 1)
  ) %>%
  arrange(match(Syndrome, c("Sepsis", "Pneumonia", "Meningitis", "Other infection")))



```

```{r Neonatal_infectious_death, echo=FALSE}
# Create the Final Table
syndrome_summary %>%
  mutate(
    Display = paste0(Count, " (", Percentage, "%)")
  ) %>%
  select(Syndrome, Display) %>%
  gt() %>%
  tab_header(
    title = md("**Summary of Syndromes in Causal Chain**")
  ) %>%
  cols_label(
    Syndrome = "Syndrome",
    Display = "# (%)"
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```

```{r Symptomps_venn, include=FALSE}
# Calculate counts for each syndrome and overlaps
sepsis_cases <- sum(AnalyticData$Sepsis)
pneumonia_cases <- sum(AnalyticData$Pneumonia)
meningitis_cases <- sum(AnalyticData$Meningitis)

# Compute overlaps between syndromes
overlap_sepsis_pneumonia <- sum(AnalyticData$Sepsis & AnalyticData$Pneumonia)
overlap_sepsis_meningitis <- sum(AnalyticData$Sepsis & AnalyticData$Meningitis)
overlap_pneumonia_meningitis <- sum(AnalyticData$Pneumonia & AnalyticData$Meningitis)

# Compute three-way overlap
overlap_sepsis_pneumonia_meningitis <- sum(AnalyticData$Sepsis & AnalyticData$Pneumonia & AnalyticData$Meningitis)


```

```{r venn, echo=FALSE}
# Generate the Venn Diagram
venn.plot <- draw.triple.venn(
  area1 = sepsis_cases,
  area2 = pneumonia_cases,
  area3 = meningitis_cases,
  n12 = overlap_sepsis_pneumonia,
  n13 = overlap_sepsis_meningitis,
  n23 = overlap_pneumonia_meningitis,
  n123 = overlap_sepsis_pneumonia_meningitis,  # All three syndromes overlap
  category = c("Sepsis", "Pneumonia", "Meningitis"),
  fill = c("skyblue", "pink", "lightgreen"),
  alpha = 0.5,
  cex = 1.5,
  cat.cex = 1.5,
  cat.col = c("skyblue", "pink", "lightgreen")
)

title <- textGrob(
  "Syndromes in the Causal Chain", 
  gp = gpar(fontsize = 16, fontface = "bold"),
  x = 0.5,
  hjust = 0.5
)

# Display the plot
grid.draw(venn.plot)
```





```{r neonatal_death, include=FALSE}


# Define Neonatal Age Groups
AnalyticData <- AnalyticData %>%
  mutate(
    neonatal_age_group = case_when(
      age_in_days <= 1 ~ "Death within first 24 hours",
      age_in_days > 1 & age_in_days <= 3 ~ "Early neonate (24 to <72hr)",
      age_in_days > 3 & age_in_days <= 6 ~ "Early neonate (72hr to 6d)",
      age_in_days >= 7 & age_in_days <= 27 ~ "Late Neonate (7 to 27 days)",
      TRUE ~ NA_character_
    )
  )

# Count Total Deaths in Each Neonatal Age Group
total_deaths <- AnalyticData %>%
  group_by(neonatal_age_group) %>%
  summarise(total_cases = n(), .groups = 'drop')

# Identify Infectious Causes of Death
infectious_causes <- AnalyticData %>%
  filter(apply(select(., all_of(vars_eti)), 1, function(row) {
    any(!is.na(row) & row != "")
  })) %>%
  group_by(neonatal_age_group) %>%
  summarise(infectious_cases = n(), .groups = 'drop')

# Subset Infectious Causes for Klebsiella pneumoniae
klebsiella_causes <- AnalyticData %>%
  filter(apply(select(., all_of(vars_eti)), 1, function(row) {
    any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE))
  })) %>%
  group_by(neonatal_age_group) %>%
  summarise(klebsiella_cases = n(), .groups = 'drop')

final_table <- final_table %>%
  filter(neonatal_age_group %in% c(
    "Death within first 24 hours (n=974)",
    "Early neonate (24 to <72hr) (n=673)",
    "Early neonate (72hr to 6d) (n=378)",
    "Late Neonate (7 to 27 days) (n=437)"
  ))



```

```{r Neonatal_death, echo=FALSE}
# Create the Final Table
final_table %>%
  gt() %>%
  tab_header(
    title = md("**Klebsiella pneumoniae in Neonatal Infectious Deaths**")
  ) %>%
  cols_label(
    neonatal_age_group = "Neonatal Age Group (n=total MITS DeCoDed)",
    infectious_display = "Infectious Cause in Chain",
    klebsiella_display = md("*K. pneumoniae* in Causal Chain (% of infectious)")
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(90)
  )

```















