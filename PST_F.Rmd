---
title: "PST_F"
author: "Wendy He"
date: "2025-07-1"
output:
  html_document: default
  pdf_document: default
---

```{r library, include=FALSE, warning = FALSE}
# Load libraries
library(tidyr)
library(dplyr)
library(readxl)
library(tidyverse)
library(viridis)
library(lubridate)
library(gt)
library(knitr)
library(kableExtra)
library(VennDiagram)
library(purrr)
library(tibble)
library(glue)

setwd("/Users/wendyyy/Documents/CHAMPS_Epi Work/Original Code")
AnalyticData <- read.csv("vw_lk_Analytics_Dataset_2024-09-18_12-12-47.csv", stringsAsFactors=FALSE, na.strings=c("",".","NA"))
TacData <- read.csv("vw_lk_TacLaboratoryResult_Pivot_2024-09-17_14-22-48.csv", stringsAsFactors=FALSE, na.strings=c("",".","NA"))
```

```{r filter, include=FALSE, warning = FALSE}
AnalyticData <-AnalyticData %>%
  filter(MITS_flag==1) %>%
  filter(publication_suspended!=1 & !is.na(publication_suspended)) %>%
  filter(sensitive_case!=1 & !is.na(sensitive_case)) %>%
  filter(M00060==1) %>%
  filter(site_name != "Nigeria")
```

```{r age_group_label, include=FALSE, warning = FALSE}
AnalyticData <- AnalyticData %>%
  mutate(
    age_group = case_when(
      age_group == "CH00716" ~ "Stillbirth",
      age_group == "CH00718" ~ "Infant (28 days to less than 12 months)",
      age_group == "CH00719" ~ "Child (12 months to less than 60 months)",
      age_group == "CH01404" ~ "Death in the first 24 hours",
      age_group == "CH01405" ~ "Early Neonate (1 to 6 days)",
      age_group == "CH01406" ~ "Late Neonate (7 to 27 days)",
      TRUE ~ age_group 
    )
  )
```

```{r New_Age, include=FALSE, warning = FALSE}
# To split the infant age group, here is the steps:
# Filter the data for the CH00718(infant) age group.
# Calculate the age of each infant in days from calc_dob to calc_dod.
# Split the filtered data into two subgroups: infants aged 28 days to less than 6 months and those aged 6 months to less than 12 months.

# Convert calc_dob and calc_dod to Date format
AnalyticData$calc_dob <- as.Date(AnalyticData$calc_dob, format="%m/%d/%y")
AnalyticData$calc_dod <- as.Date(AnalyticData$calc_dod, format="%m/%d/%y")

head(AnalyticData$calc_dob)
head(AnalyticData$calc_dod) 

AnalyticData <- AnalyticData %>%
  mutate(age_in_days = as.numeric(difftime(calc_dod, calc_dob, units = "days")),
         
           # Create infant subgroup for age group CH00718
         infant_subgroup = case_when(
           age_group == "CH00718" & age_in_days >= 28 & age_in_days < 182 ~ "28 days to <6 months",
           age_group == "CH00718" & age_in_days >= 182 & age_in_days < 365 ~ "6 months to <12 months",
           TRUE ~ NA_character_
         ),
         
          # Create neonate subgroup
         Neonatal_Age_Group = case_when(
           age_group == "CH01404" ~ "Death within first 24 hours",
           age_group == "CH01405" & age_in_days >= 1 & age_in_days < 3 ~ "Early neonate (24 to <72hr)",
           age_group == "CH01405" & age_in_days >= 3 & age_in_days <= 6 ~ "Early neonate (72hr to 6 days)",
           age_group == "CH01406" ~ "Late Neonate (7 to 27 days)",
           TRUE ~ NA_character_
  ))
         

```

```{r Staph, include=FALSE, warning = FALSE}
##### Task 2 #####


vars_eti<-c("Underlying_Cause_Factor_etiol1","Underlying_Cause_Factor_etiol1_othr","Underlying_Cause_Factor_etiol2","Underlying_Cause_Factor_etiol2_othr",
            "Underlying_Cause_Factor_etiol3","Underlying_Cause_Factor_etiol3_othr","Immediate_Cause_of_Death_etiol1","Immediate_Cause_of_Death_etiol1_othr",
            "Immediate_Cause_of_Death_etiol2","Immediate_Cause_of_Death_etiol2_othr","Immediate_Cause_of_Death_etiol3","Immediate_Cause_of_Death_etiol3_othr",
            "Morbid_Condition_01_etiol1","Morbid_Condition_01_etiol1_othr","Morbid_Condition_01_etiol2","Morbid_Condition_01_etiol2_othr",
            "Morbid_Condition_01_etiol3","Morbid_Condition_01_etiol3_othr","Morbid_Condition_02_etiol1","Morbid_Condition_02_etiol1_othr",     
            "Morbid_Condition_02_etiol2","Morbid_Condition_02_etiol2_othr","Morbid_Condition_02_etiol3","Morbid_Condition_02_etiol3_othr",
            "Morbid_Condition_03_etiol1","Morbid_Condition_03_etiol1_othr","Morbid_Condition_03_etiol2","Morbid_Condition_03_etiol2_othr",
            "Morbid_Condition_03_etiol3","Morbid_Condition_03_etiol3_othr","Morbid_Condition_04_etiol1","Morbid_Condition_04_etiol1_othr",
            "Morbid_Condition_04_etiol2","Morbid_Condition_04_etiol2_othr","Morbid_Condition_04_etiol3","Morbid_Condition_04_etiol3_othr",
            "Morbid_Condition_05_etiol1","Morbid_Condition_05_etiol1_othr","Morbid_Condition_05_etiol2","Morbid_Condition_05_etiol2_othr",
            "Morbid_Condition_05_etiol3","Morbid_Condition_05_etiol3_othr","Morbid_Condition_06_etiol1","Morbid_Condition_06_etiol1_othr",
            "Morbid_Condition_06_etiol2","Morbid_Condition_06_etiol2_othr","Morbid_Condition_06_etiol3","Morbid_Condition_06_etiol3_othr",
            "Morbid_Condition_07_etiol1","Morbid_Condition_07_etiol1_othr","Morbid_Condition_07_etiol2","Morbid_Condition_07_etiol2_othr",
            "Morbid_Condition_07_etiol3","Morbid_Condition_07_etiol3_othr","Morbid_Condition_08_etiol1","Morbid_Condition_08_etiol1_othr",
            "Morbid_Condition_08_etiol2","Morbid_Condition_08_etiol2_othr","Morbid_Condition_08_etiol3","Morbid_Condition_08_etiol3_othr") 

countries_of_interest <- c("Bangladesh", "Ethiopia", "Kenya", "Mali", "Mozambique", "Sierra Leone", "South Africa")

staph_cases <- AnalyticData %>%
  filter(apply(AnalyticData[vars_eti], 1, function(row) any(grepl("Staphylococcus aureus", row, ignore.case = TRUE))))


# Calculate the total number of deaths for each age group from the original dataset
total_deaths_by_age <- AnalyticData %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n())  # Total number of deaths in each age group

print(total_deaths_by_age)

# Calculate the number of Staphylococcus aureus cases for each age group from the filtered staph_cases
staph_cases_by_age <- staph_cases %>%
  group_by(age_group) %>%
  summarise(Staph_Cases = n())  # Count of Staphylococcus aureus cases in each age group

print(staph_cases_by_age)

# Merge both summaries to calculate the percentage of Staphylococcus aureus deaths
age_group_summary <- left_join(total_deaths_by_age, staph_cases_by_age, by = "age_group") %>%
  mutate(
    Staph_Cases = replace_na(Staph_Cases, 0),  # Replace NA with 0
    Percentage_Staph = (Staph_Cases / Total_Deaths) * 100  # Calculate the percentage
  )

# Print the final summary table
age_group_summary %>%
  kable(
    caption = "Summary of Staphylococcus aureus Deaths by Age Group",
    col.names = c("Age Group", "Total Deaths", "Staph Cases", "Percentage Staph Deaths (%)"),
    align = "c"
  ) %>%
  kable_styling(full_width = FALSE, position = "center") %>%
  row_spec(0, background = "lightgreen") %>%     # Header row in light green
  row_spec(1:nrow(age_group_summary), background = "honeydew") # All rows with a soft green background


# CH00716 Stillbirth
# CH00718 Infant (28 days to less than 12 months)
# CH00719 Child (12 months to less than 60 Months)
# CH01404	Death in the first 24 hours
# CH01405	Early Neonate (1 to 6 days)
# CH01406	Late Neonate (7 to 27 days) 

```

## ***Staphylococcus aureus***

```{r Staph_Death, include=FALSE}

#### Task 3 #####

# Filter Staphylococcus aureus cases in the causal chain
staph_cases_ch <- AnalyticData %>%
  filter(apply(AnalyticData[vars_eti], 1, function(row) any(grepl("Staphylococcus aureus", row, ignore.case = TRUE))))

# Calculate the total number of deaths for each age group
total_deaths_by_age <- AnalyticData %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n(), .groups = 'drop')

# Calculate the number of Staphylococcus aureus cases (causal chain) for each age group
staph_cases_by_age <- staph_cases_ch %>%
  group_by(age_group) %>%
  summarise(Staph_Cases_ch = n(), .groups = 'drop')

# Process TacData for detected S. aureus deaths
# Rename and join TacData with age groups
TacData_S <- TacData %>%
  rename(Champsid = ChampsID)

Tac_filtered <- TacData_S %>%
  filter(Champsid %in% AnalyticData$Champsid) %>%
  left_join(select(AnalyticData, Champsid, age_group), by = "Champsid") %>%
  mutate(
    S_aureus_detected = ifelse(bld_STAU_2 == "Positive" | CSF_STAU_2 == "Positive" | lung_STAU_2 == "Positive", 1, 0))

# Summarize detected S. aureus deaths by age group
s_aureus_detected <- Tac_filtered %>%
  group_by(age_group) %>%
  summarise(S_aureus_Detected_Deaths = sum(S_aureus_detected, na.rm = TRUE), .groups = 'drop')

# Merge summaries and calculate percentages
age_group_summary <- total_deaths_by_age %>%
  left_join(staph_cases_by_age, by = "age_group") %>%
  left_join(s_aureus_detected, by = "age_group") %>%
  mutate(
    Staph_Cases_ch = replace_na(Staph_Cases_ch, 0),
    S_aureus_Detected_Deaths = replace_na(S_aureus_Detected_Deaths, 0),
    Percentage_Staph = (Staph_Cases_ch / Total_Deaths) * 100
  )

# Combine Staph Cases and Percentages into a single column
age_group_summary <- age_group_summary %>%
  mutate(
    S_aureus_Cases_Combined = paste0(
      Staph_Cases_ch, " (", round(Percentage_Staph, 2), "%)"
    )
  ) %>%
  select(
    age_group,
    Total_Deaths,
    S_aureus_Detected_Deaths,
    S_aureus_Cases_Combined
  )

# Arrange by age group order
age_group_summary <- age_group_summary %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Stillbirth",
        "Death in the first 24 hours",
        "Early Neonate (1 to 6 days)",
        "Late Neonate (7 to 27 days)",
        "Infant (28 days to less than 12 months)",
        "Child (12 months to less than 60 months)"
      )
    )
  ) %>%
  arrange(age_group)

# Calculate the total row
total_row <- age_group_summary %>%
  summarise(
    age_group = "Total",  # Label the total row
    Total_Deaths = sum(Total_Deaths, na.rm = TRUE),
    S_aureus_Detected_Deaths = sum(S_aureus_Detected_Deaths, na.rm = TRUE),
    S_aureus_Cases_Combined = paste0(
      sum(as.numeric(str_extract(S_aureus_Cases_Combined, "^[0-9]+")), na.rm = TRUE), 
      " (",
      round(sum(as.numeric(str_extract(S_aureus_Cases_Combined, "(?<=\\().+(?=%\\))")), na.rm = TRUE) / nrow(age_group_summary), 2), 
      "%)"
    )
  )


final_summary <- bind_rows(age_group_summary, total_row)



```

```{r Staph_Death_graph, echo=FALSE} 
# Final table with the total row
final_summary %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *S. aureus* Deaths by Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Total_Deaths = "Total Deaths",
    S_aureus_Detected_Deaths = md("*S. aureus* Detected Deaths"),
    S_aureus_Cases_Combined = md("*S. aureus* Cases (Causal Chain) %")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body(rows = nrow(final_summary))  # Highlight the total row
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )
```


```{r Task4, include=FALSE, warning = FALSE}
### Final Task 4 ###

# Define locations
locations <- c("Bangladesh", "Ethiopia", "Kenya", "Mali", "Mozambique", "Sierra Leone", "South Africa")

# Dynamically compute total population per location
location_data <- tibble(
  Location = locations,
  Total_People = sapply(locations, function(loc) sum(AnalyticData$site_name == loc, na.rm = TRUE))
)

# Create location names using glue
location_labels <- sapply(1:nrow(location_data), function(i) {
  glue("{location_data$Location[i]} (n={location_data$Total_People[i]})")
})
names(location_labels) <- location_data$Location  # Mapping for column renaming

# Extract unique age groups
age_groups <- unique(AnalyticData$age_group)

# Compute total people per age group
age_group_data <- tibble(
  Age_Group = age_groups,
  Total_People = sapply(age_groups, function(ag) sum(AnalyticData$age_group == ag, na.rm = TRUE))
)

# Filter valid vars_eti
vars_eti_valid <- vars_eti[vars_eti %in% colnames(AnalyticData)]

vars_eti_valid <- vars_eti[vars_eti %in% colnames(AnalyticData)]

# Subset only columns we want to check
search_matrix <- AnalyticData[, vars_eti_valid]

# Identify rows where Staph is found in any column
staph_flag <- apply(search_matrix, 1, function(row) {
  any(grepl("Staphylococcus aureus", row, ignore.case = TRUE))
})

# Filter Staph cases
staph_cases <- AnalyticData %>%
  filter(staph_flag) %>%
  select(site_name, age_group) %>%
  filter(site_name %in% location_data$Location)

# Count cases by site and age group
staph_counts <- staph_cases %>%
  count(site_name, age_group, name = "Staph_Cases")

# Reshape data with site_name as columns
staph_table <- staph_counts %>%
  pivot_wider(names_from = site_name, values_from = Staph_Cases, values_fill = list(Staph_Cases = 0))

# Ensure numeric for calculations
staph_table <- staph_table %>%
  mutate(across(all_of(locations), as.numeric))

# Compute Total (Row %)
staph_table <- staph_table %>%
  rowwise() %>%
  mutate(
    Total_cases = sum(c_across(all_of(locations)), na.rm = TRUE),
    Age_Group_Population = age_group_data %>% 
      filter(Age_Group == age_group) %>% 
      pull(Total_People),
    `Total (Row %)` = glue("{Total_cases} ({round((Total_cases / Age_Group_Population) * 100, 1)}%)")
  ) %>%
  ungroup() %>%
  select(-Age_Group_Population, -Total_cases)

# Compute site totals
site_totals <- staph_table %>%
  summarise(across(all_of(locations), ~ sum(.x, na.rm = TRUE)))

# Create TOTAL row
total_row <- site_totals %>%
  mutate(age_group = "TOTAL")

# Format site totals with percentages
for (loc in locations) {
  site_total <- as.numeric(total_row[[loc]])
  population <- location_data %>% filter(Location == loc) %>% pull(Total_People)
  total_row[[loc]] <- glue("{site_total} ({round((site_total / population) * 100, 1)}%)")
}

# Format TOTAL (Row %) column
total_row <- total_row %>%
  mutate(`Total (Row %)` = glue("{sum(as.numeric(unlist(site_totals)), na.rm = TRUE)} ({round(sum(as.numeric(unlist(site_totals)), na.rm = TRUE) / sum(location_data$Total_People) * 100, 1)}%)"))

# Convert all location columns to character
staph_table <- staph_table %>%
  mutate(across(all_of(locations), as.character))


final_table <- staph_table %>%
  bind_rows(total_row) %>%
  filter(!is.na(age_group))


age_group_order <- c(
  "Stillbirth",
  "Death in the first 24 hours",
  "Early Neonate (1 to 6 days)",
  "Late Neonate (7 to 27 days)",
  "Infant (28 days to less than 12 months)",
  "Child (12 months to less than 60 months)",
  "TOTAL"
)

# Extract raw age group names for sorting
final_table <- final_table %>%
  mutate(
    raw_age_group = case_when(
      age_group == "TOTAL" ~ "TOTAL",
      TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
    ),
    raw_age_group = factor(raw_age_group, levels = age_group_order)
  ) %>%
  arrange(raw_age_group) %>%
  select(-raw_age_group)


age_group_totals <- AnalyticData %>%
  group_by(age_group) %>%
  summarise(total_people_age_group = n(), .groups = "drop")

print(age_group_totals)



# Add age group totals to final_table using the raw age group name
final_table <- final_table %>%
  mutate(raw_age_group = case_when(
    age_group == "TOTAL" ~ "TOTAL",
    TRUE ~ gsub(" \\(n=.*\\)", "", age_group)  # Strip any existing labels
  )) %>%
  left_join(age_group_totals, by = c("raw_age_group" = "age_group")) %>%
  mutate(
    age_group = ifelse(
      raw_age_group == "TOTAL",
      "TOTAL",
      glue("{raw_age_group} (n={total_people_age_group})")
    )
  ) %>%
  select(-raw_age_group, -total_people_age_group)




# Rename columns with glue-generated labels
colnames(final_table) <- c("Age Group", location_labels, "Total (Row %)")

# View result
#View(final_table)

```

```{r Staph_age_loc, echo=FALSE}

gt_table <- final_table %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *Staphylococcus aureus* Cases by Age Group and Location**")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )


gt_table

```


## ***Klebsiella Pneumoniae***

```{r KP_age, include=FALSE}
### Updated for Klebsiella pneumoniae ###


age_group_mapping <- c(
  "CH00716" = "Stillbirth",
  "CH00718" = "Infant (28 days to less than 12 months)",
  "CH00719" = "Child (12 months to less than 60 months)",
  "CH01404" = "Death in the first 24 hours",
  "CH01405" = "Early Neonate (1 to 6 days)",
  "CH01406" = "Late Neonate (7 to 27 days)"
)


AnalyticData_K <- AnalyticData %>%
  mutate(
    age_group = recode(age_group, !!!age_group_mapping))


kp_cases_ch <- AnalyticData_K %>%
  filter(apply(AnalyticData_K[vars_eti], 1, function(row) any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE))))



# Calculate the total number of deaths for each age group
total_deaths_by_age <- AnalyticData_K %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n(), .groups = 'drop')

# Calculate the number of Klebsiella cases (causal chain) for each age group
kp_cases_by_age <- kp_cases_ch %>%
  group_by(age_group) %>%
  summarise(KP_Cases_ch = n(), .groups = 'drop')


TacData_K <- TacData %>%
  rename(ChampsID = Champsid)

Tac_filtered <- TacData_K %>%
  filter(Champsid %in% AnalyticData_K$Champsid) %>%
  left_join(select(AnalyticData_K, Champsid, age_group), by = "Champsid") %>%
  mutate(
    KP_detected = ifelse(bld_KLPN_1 == "Positive" | CSF_KLPN_1 == "Positive" | lung_KLPN_1 == "Positive", 1, 0))

# Summarize detected Klebsiella deaths by age group
kp_detected <- Tac_filtered %>%
  group_by(age_group) %>%
  summarise(KP_Detected_Deaths = sum(KP_detected, na.rm = TRUE), .groups = 'drop')

# Merge summaries and calculate percentages
age_group_summary <- total_deaths_by_age %>%
  left_join(kp_cases_by_age, by = "age_group") %>%
  left_join(kp_detected, by = "age_group") %>%
  mutate(
    KP_Cases_ch = replace_na(KP_Cases_ch, 0),
    KP_Detected_Deaths = replace_na(KP_Detected_Deaths, 0),
    Percentage_KP = (KP_Cases_ch / Total_Deaths) * 100
  )

# Combine Klebsiella Cases and Percentages into a single column
age_group_summary <- age_group_summary %>%
  mutate(
    KP_Cases_Combined = paste0(
      KP_Cases_ch, " (", round(Percentage_KP, 2), "%)"
    )
  ) %>%
  select(
    age_group,
    Total_Deaths,
    KP_Detected_Deaths,
    KP_Cases_Combined
  )

# Arrange by age group order
age_group_summary <- age_group_summary %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Stillbirth",
        "Death in the first 24 hours",
        "Early Neonate (1 to 6 days)",
        "Late Neonate (7 to 27 days)",
        "Infant (28 days to less than 12 months)",
        "Child (12 months to less than 60 months)"
      )
    )
  ) %>%
  arrange(age_group)

# Calculate the total row
total_row <- age_group_summary %>%
  summarise(
    age_group = "Total",  # Label the total row
    Total_Deaths = sum(Total_Deaths, na.rm = TRUE),
    KP_Detected_Deaths = sum(KP_Detected_Deaths, na.rm = TRUE),
    KP_Cases_Combined = paste0(
      sum(as.numeric(str_extract(KP_Cases_Combined, "^[0-9]+")), na.rm = TRUE), 
      " (",
      round(sum(as.numeric(str_extract(KP_Cases_Combined, "(?<=\\().+(?=%\\))")), na.rm = TRUE) / nrow(age_group_summary), 2), 
      "%)"
    )
  )

final_summary <- bind_rows(age_group_summary, total_row)


```

```{r KP_age_table, echo=FALSE}

final_summary %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *K. pneumoniae* Deaths by Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Total_Deaths = "Total Deaths",
    KP_Detected_Deaths = md("*K. pneumoniae* Detected Deaths"),
    KP_Cases_Combined = md("*K. pneumoniae* Cases (Causal Chain) %")
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body(rows = nrow(final_summary))  # Highlight the total row
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```


```{r KP_loca_age, include=FALSE, warning = FALSE}
# Task 4 KP # 


kleb_flag <- apply(search_matrix, 1, function(row) {
  any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE))
})

# Filter Klebsiella cases
kleb_cases <- AnalyticData_K %>%
  filter(kleb_flag) %>%
  select(site_name, age_group) %>%
  filter(site_name %in% location_data$Location)

# Count cases by site and age group
kleb_counts <- kleb_cases %>%
  count(site_name, age_group, name = "Klebsiella_Cases")

# Reshape data with site_name as columns
kleb_table <- kleb_counts %>%
  pivot_wider(names_from = site_name, values_from = Klebsiella_Cases, values_fill = list(Klebsiella_Cases = 0))


kleb_table <- kleb_table %>%
  mutate(across(all_of(locations), as.numeric))

# Compute Total (Row %)
kleb_table <- kleb_table %>%
  rowwise() %>%
  mutate(
    Total_cases = sum(c_across(all_of(locations)), na.rm = TRUE),
    Age_Group_Population = age_group_data %>% 
      filter(Age_Group == age_group) %>% 
      pull(Total_People),
    `Total (Row %)` = glue("{Total_cases} ({round((Total_cases / Age_Group_Population) * 100, 1)}%)")
  ) %>%
  ungroup() %>%
  select(-Age_Group_Population, -Total_cases)

# Compute site totals
site_totals <- kleb_table %>%
  summarise(across(all_of(locations), ~ sum(.x, na.rm = TRUE)))

# Create TOTAL row
total_row <- site_totals %>%
  mutate(age_group = "TOTAL")

# Format site totals with percentages
for (loc in locations) {
  site_total <- as.numeric(total_row[[loc]])
  population <- location_data %>% filter(Location == loc) %>% pull(Total_People)
  total_row[[loc]] <- glue("{site_total} ({round((site_total / population) * 100, 1)}%)")
}

# Format TOTAL (Row %) column
total_row <- total_row %>%
  mutate(`Total (Row %)` = glue("{sum(as.numeric(unlist(site_totals)), na.rm = TRUE)} ({round(sum(as.numeric(unlist(site_totals)), na.rm = TRUE) / sum(location_data$Total_People) * 100, 1)}%)"))


kleb_table <- kleb_table %>%
  mutate(across(all_of(locations), as.character))


final_table <- kleb_table %>%
  bind_rows(total_row) %>%
  filter(!is.na(age_group))


age_group_order <- c(
  "Stillbirth",
  "Death in the first 24 hours",
  "Early Neonate (1 to 6 days)",
  "Late Neonate (7 to 27 days)",
  "Infant (28 days to less than 12 months)",
  "Child (12 months to less than 60 months)",
  "TOTAL"
)

# Extract raw age group names for sorting
final_table <- final_table %>%
  mutate(
    raw_age_group = case_when(
      age_group == "TOTAL" ~ "TOTAL",
      TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
    ),
    raw_age_group = factor(raw_age_group, levels = age_group_order)
  ) %>%
  arrange(raw_age_group) %>%
  select(-raw_age_group)


age_group_totals <- AnalyticData %>%
  group_by(age_group) %>%
  summarise(total_people_age_group = n(), .groups = "drop")

# Add age group totals to final_table using the raw age group name
final_table <- final_table %>%
  mutate(raw_age_group = case_when(
    age_group == "TOTAL" ~ "TOTAL",
    TRUE ~ gsub(" \\(n=.*\\)", "", age_group)  
  )) %>%
  left_join(age_group_totals, by = c("raw_age_group" = "age_group")) %>%
  mutate(
    age_group = ifelse(
      raw_age_group == "TOTAL",
      "TOTAL",
      glue("{raw_age_group} (n={total_people_age_group})")
    )
  ) %>%
  select(-raw_age_group, -total_people_age_group)


colnames(final_table) <- c("Age Group", location_labels, "Total (Row %)")

```

```{r echo=FALSE}

gt_table <- final_table %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *K. pneumoniae* Cases by Age Group and Location**")
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )


gt_table
```



```{r Month_old_variable, include=FALSE, warning = FALSE}
### Create table for KP death summary in 28days and 6 months by age in months


AnalyticData_K <- AnalyticData_K %>%
  mutate(
    calc_dob = ymd(calc_dob),  # Convert calc_dob to date
    calc_dod = ymd(calc_dod)   # Convert calc_dod to date
  )

# Calculate age in days
AnalyticData_K <- AnalyticData_K %>%
  mutate(age_in_days = as.numeric(difftime(calc_dod, calc_dob, units = "days")))

# Create the `month_old` column
AnalyticData_K1 <- AnalyticData_K %>%
  mutate(
    month_old = case_when(
      case_type_calc == "CH00718" & age_in_days >= 28 & age_in_days < 60 ~ "28d to <2 months",
      case_type_calc == "CH00718" & age_in_days >= 60 & age_in_days < 90 ~ "2 to <3 months",
      case_type_calc == "CH00718" & age_in_days >= 90 & age_in_days < 120 ~ "3 to <4 months",
      case_type_calc == "CH00718" & age_in_days >= 120 & age_in_days < 150 ~ "4 to <5 months",
      case_type_calc == "CH00718" & age_in_days >= 150 & age_in_days < 180 ~ "5 to <6 months",
      TRUE ~ NA_character_  # Keep other age groups unchanged
    )
  )


AnalyticData_K1 <- AnalyticData_K1 %>%
  filter(!is.na(month_old))  # Keep only infant age groups split by month



print(AnalyticData_K1$month_old)

```

```{r Month_old_table, include=FALSE, warning = FALSE}

# Task 5
#Calculate total number of people (n=) in each `month_old` group, excluding NAs
month_totals <- AnalyticData_K1 %>%
  filter(!is.na(month_old)) %>%  # Exclude NA values
  group_by(month_old) %>%
  summarise(Total_people = n()) %>%  # Count total people in each `month_old` group
  mutate(
    month_old = factor(month_old, levels = c(
      "28d to <2 months",  
      "2 to <3 months",    
      "3 to <4 months",
      "4 to <5 months",
      "5 to <6 months"
    ))
  )

print(month_totals)

#Filter Klebsiella cases in the causal chain
kp_cases_month <- AnalyticData_K1 %>%
  filter(!is.na(month_old)) %>%  # Exclude NA values
  filter(apply(select(., all_of(vars_eti)), 1, function(row) any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE)))) %>%
  group_by(month_old) %>%
  summarise(K_pneumoniae_ch = n()) %>%  # Summarize cases
  left_join(month_totals, by = "month_old") %>%  # Add total people per `month_old`
  mutate(
    Percent = round((K_pneumoniae_ch / Total_people) * 100, 1),  # Correct percentage calculation
    `K_pneumoniae_ch (%)` = paste0(K_pneumoniae_ch, " (", Percent, "%)")
  )


TacData <- TacData %>%
  rename(Champsid = Champsid) 

#Filter TacData for Klebsiella cases, merge with AnalyticData
TacData <- TacData %>%
  filter(Champsid %in% AnalyticData_K1$Champsid) %>%  
  left_join(select(AnalyticData_K1, Champsid, month_old), by = "Champsid") %>%  
  filter(!is.na(month_old)) %>%  # Exclude NA values
  mutate(
    K_pneumoniae_detected = ifelse(
      bld_KLPN_1 == "Positive" | CSF_KLPN_1 == "Positive" | lung_KLPN_1 == "Positive", 1, 0  
    )
  )

#Summarize Klebsiella detected in TAC by month_old
kp_tac_summary <- TacData %>%
  filter(K_pneumoniae_detected == 1) %>%  # Include only detected cases
  group_by(month_old) %>%
  summarise(K_pneumoniae_TAC = n()) %>%
  left_join(month_totals, by = "month_old") %>%  # Add total people per `month_old`
  mutate(
    TAC_Percent = round((K_pneumoniae_TAC / Total_people) * 100, 1),  
    `K_pneumoniae_in_TAC` = paste0(K_pneumoniae_TAC, " (", TAC_Percent, "%)")
  )


kp_combined <- kp_tac_summary %>%
  left_join(kp_cases_month, by = "month_old") %>%
  mutate(
    month_old_label = case_when(
      month_old == "28d to <2 months" ~ "28d to <2 months (n=178)",  
      month_old == "2 to <3 months" ~ "2 to <3 months (n=106)",      
      month_old == "3 to <4 months" ~ "3 to <4 months (n=82)",       
      month_old == "4 to <5 months" ~ "4 to <5 months (n=61)",       
      month_old == "5 to <6 months" ~ "5 to <6 months (n=73)"        
    )
  ) %>%
  arrange(factor(month_old, levels = c(
    "28d to <2 months",  
    "2 to <3 months",    
    "3 to <4 months",
    "4 to <5 months",
    "5 to <6 months"
  ))) %>%
  select(
    month_old_label,  
    `K_pneumoniae_in_TAC`,  
    `K_pneumoniae_ch (%)`
  ) %>%
  filter(!is.na(month_old_label))
```

```{r Month_old_final, echo=FALSE, message=FALSE}


kp_combined %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *K. pneumoniae* in Causal Chain and TAC by Month Old**")
  ) %>%
  cols_label(
    month_old_label = "Month Old",
    `K_pneumoniae_ch (%)` = md("*K. pneumoniae* in Causal Chain (%)"),
    `K_pneumoniae_in_TAC` = md("*K. pneumoniae* in TAC (%)")
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )
```

```{r Check_up, include=FALSE}
unique_values_uc <- sort(unique(AnalyticData$UC_champs_group_desc))
unique_values_ic <- sort(unique(AnalyticData$IC_champs_group_desc))
table_uc <- table(AnalyticData$UC_champs_group_desc)
table_IC <- table(AnalyticData$IC_champs_group_desc)

print("Unique values in UC_champs_group_desc:")
print(unique_values_uc)
print("Table for UC_champs_group_desc:")
print(table_uc) 
print(table_IC)
```

```{r Symptoms, include=FALSE}


# Define Syndrome Groups
syndrome_mapping <- list(
  sepsis = c("sepsis", "Neonatal sepsis"),
  pneumonia = c("Lower respiratory infections"),
  meningitis = c("Meningitis/Encephalitis")
)

AnalyticData_K <- AnalyticData_K %>%
  filter(
    apply(select(., all_of(vars_eti)), 1, function(row) {
      any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE))
    })
  )

# Create Indicators for Each Syndrome in AnalyticData
AnalyticData_K <- AnalyticData_K %>%
  mutate(
    Sepsis_Causal_Chain = ifelse(
      grepl(paste(syndrome_mapping$sepsis, collapse = "|"), UC_champs_group_desc, ignore.case = TRUE) |
      grepl(paste(syndrome_mapping$sepsis, collapse = "|"), IC_champs_group_desc, ignore.case = TRUE) |
      apply(select(., starts_with("Morbid_Cond_")), 1, function(row) {
        any(grepl(paste(syndrome_mapping$sepsis, collapse = "|"), row, ignore.case = TRUE))
      }),
      1, 0
    ),
    Pneumonia_Causal_Chain = ifelse(
      grepl(paste(syndrome_mapping$pneumonia, collapse = "|"), UC_champs_group_desc, ignore.case = TRUE) |
      grepl(paste(syndrome_mapping$pneumonia, collapse = "|"), IC_champs_group_desc, ignore.case = TRUE) |
      apply(select(., starts_with("Morbid_Cond_")), 1, function(row) {
        any(grepl(paste(syndrome_mapping$pneumonia, collapse = "|"), row, ignore.case = TRUE))
      }),
      1, 0
    ),
    Meningitis_Causal_Chain = ifelse(
      grepl(paste(syndrome_mapping$meningitis, collapse = "|"), UC_champs_group_desc, ignore.case = TRUE) |
      grepl(paste(syndrome_mapping$meningitis, collapse = "|"), IC_champs_group_desc, ignore.case = TRUE) |
      apply(select(., starts_with("Morbid_Cond_")), 1, function(row) {
        any(grepl(paste(syndrome_mapping$meningitis, collapse = "|"), row, ignore.case = TRUE))
      }),
      1, 0
    )
  )

# Add Other Infections Indicator
AnalyticData_K <- AnalyticData_K %>%
  mutate(
    Other_Infections = ifelse(
      Sepsis_Causal_Chain == 0 & Pneumonia_Causal_Chain == 0 & Meningitis_Causal_Chain == 0, 1, 0
    )
  )

# Summarize Data
syndrome_summary <- AnalyticData_K %>%
  summarise(
    Total_Cases = n(),
    Sepsis_Cases = sum(Sepsis_Causal_Chain, na.rm = TRUE),
    Pneumonia_Cases = sum(Pneumonia_Causal_Chain, na.rm = TRUE),
    Meningitis_Cases = sum(Meningitis_Causal_Chain, na.rm = TRUE),
    Other_Infection_Cases = sum(Other_Infections, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = Sepsis_Cases:Other_Infection_Cases,
    names_to = "Syndrome",
    values_to = "Count"
  ) %>%
  mutate(
    Syndrome = case_when(
      Syndrome == "Sepsis_Cases" ~ "Sepsis",
      Syndrome == "Pneumonia_Cases" ~ "Pneumonia",
      Syndrome == "Meningitis_Cases" ~ "Meningitis",
      Syndrome == "Other_Infection_Cases" ~ "Other infection"
    ),
    Percentage = round((Count / Total_Cases) * 100, 1)
  ) %>%
  arrange(match(Syndrome, c("Sepsis", "Pneumonia", "Meningitis", "Other infection")))



```

```{r KP in causal chain, echo=FALSE}

syndrome_summary %>%
  mutate(
    Display = paste0(Count, " (", Percentage, "%)")
  ) %>%
  select(Syndrome, Display) %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *K. pneumoniae* Syndromes in Causal Chain**")
  ) %>%
  cols_label(
    Syndrome = "Syndrome",
    Display = "# (%)"
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```

```{r Symptomps_venn, include=FALSE}
# Calculate counts for each syndrome and overlaps
sepsis_cases <- sum(AnalyticData_K$Sepsis)
pneumonia_cases <- sum(AnalyticData_K$Pneumonia)
meningitis_cases <- sum(AnalyticData_K$Meningitis)

# Compute overlaps between syndromes
overlap_sepsis_pneumonia <- sum(AnalyticData_K$Sepsis & AnalyticData_K$Pneumonia)
overlap_sepsis_meningitis <- sum(AnalyticData_K$Sepsis & AnalyticData_K$Meningitis)
overlap_pneumonia_meningitis <- sum(AnalyticData_K$Pneumonia & AnalyticData_K$Meningitis)

# Compute three-way overlap
overlap_sepsis_pneumonia_meningitis <- sum(AnalyticData_K$Sepsis & AnalyticData_K$Pneumonia & AnalyticData_K$Meningitis)


```



```{r venn, echo=FALSE}

# Task 6
# Generate the Venn Diagram
venn.plot <- draw.triple.venn(
  area1 = sepsis_cases,
  area2 = pneumonia_cases,
  area3 = meningitis_cases,
  n12 = overlap_sepsis_pneumonia,
  n13 = overlap_sepsis_meningitis,
  n23 = overlap_pneumonia_meningitis,
  n123 = overlap_sepsis_pneumonia_meningitis,  # All three syndromes overlap
  category = c("Sepsis", "Pneumonia", "Meningitis"),
  fill = c("skyblue", "pink", "lightgreen"),
  alpha = 0.5,
  cex = 1.5,
  cat.cex = 1.5,
  cat.col = c("skyblue", "pink", "lightgreen")
)

title <- textGrob(
  "Syndromes in the Causal Chain", 
  gp = gpar(fontsize = 16, fontface = "bold"),
  x = 0.5,
  hjust = 0.5
)

# Display the plot
grid.draw(venn.plot)
```

```{r calculate neonatal infecious deaths, include=FALSE}
# Define infectious causes
infectious_causes <- c(
  "Diarrheal Diseases", "Congenital infection", "HIV", "Lower respiratory infections",
  "Malaria", "Measles", "Meningitis/Encephalitis", "Neonatal sepsis", "Sepsis",
  "Other infections", "Syphilis", "Tuberculosis", "Upper respiratory infections"
)

#Identify if each case has an infectious cause
AnalyticData_K <- AnalyticData_K %>%
  mutate(
    Infectious_Cause = ifelse(
      IC_champs_group_desc %in% infectious_causes | UC_champs_group_desc %in% infectious_causes, 1, 0
    )
  )


AnalyticData_K <- AnalyticData_K %>%
  mutate(
    Kp_Causal_Chain = ifelse(
      apply(select(., all_of(vars_eti)), 1, function(row) any(grepl("Klebsiella pneumoniae", row, ignore.case = TRUE))),
      1, 0
    )
  )


summary_table <- AnalyticData_K %>%
  group_by(Neonatal_Age_Group) %>%
  summarise(
    total_deaths = n(),
    infectious_cases = sum(Infectious_Cause, na.rm = TRUE), # Count of deaths with infectious causes
    kp_cases = sum(Kp_Causal_Chain * Infectious_Cause, na.rm = TRUE) # Count of Klebsiella pneumoniae cases among infectious deaths
  ) %>%
  mutate(
    infectious_percent = ifelse(total_deaths > 0, round((infectious_cases / total_deaths) * 100), 0),
    kp_percent = ifelse(infectious_cases > 0, round((kp_cases / infectious_cases) * 100), 0)
  ) %>%
  mutate(
    total_deaths = paste0("n=", total_deaths),
    infectious_cases = paste0(infectious_cases, " (", infectious_percent, "%)"),
    kp_cases = ifelse(!is.na(kp_percent), paste0(kp_cases, " (", kp_percent, "%)"), paste0(kp_cases, " (0%)"))
  ) %>%
  filter(!is.na(Neonatal_Age_Group))


```

```{r Neonatal_infectious_death, echo=FALSE}
summary_table %>%
  select(Neonatal_Age_Group, total_deaths, infectious_cases, kp_cases) %>%
  gt() %>%
  cols_label(
    Neonatal_Age_Group = "Neonatal Age Group (n=total MITS DeCoDed)",
    infectious_cases = "Infectious Cause in Chain",
    kp_cases = md("Summary of *K. pneumoniae* in Causal Chain (% of infectious)")
  ) %>%
  tab_header(
    title = md("**Neonatal Infectious Deaths**")
  ) %>%
  tab_style(
    style = cell_fill(color = "purple"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lavender"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )
```


## ***E-Coli***

```{r E_coli_3, include=FALSE, warning = FALSE}

AnalyticData_E <- AnalyticData %>%
  mutate(
    age_group = recode(age_group, !!!age_group_mapping))

 
ecoli_cases_ch <- AnalyticData_E %>%
  filter(apply(select(., all_of(vars_eti)), 1, function(row) {
    any(grepl("Escherichia coli", row, ignore.case = TRUE) |
        grepl("Shigella", row, ignore.case = TRUE))
  }))

# Total deaths per age group 
total_deaths_by_age <- AnalyticData_E %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n(), .groups = 'drop')

# E. coli cases from causal chain
ecoli_cases_by_age <- ecoli_cases_ch %>%
  group_by(age_group) %>%
  summarise(Ecoli_Cases_ch = n(), .groups = 'drop')

# Detect E. coli from TAC
TacData_E <- TacData %>%
  rename(Champsid = ChampsID)

Tac_filtered <- TacData_E %>%
  filter(Champsid %in% AnalyticData_E$Champsid) %>%
  left_join(select(AnalyticData_E, Champsid, age_group), by = "Champsid") %>%
  mutate(
    Ecoli_detected = ifelse(
      grepl("positive", bld_ECSH_1, ignore.case = TRUE) |
      grepl("positive", bld_sp_ECSH_1, ignore.case = TRUE) |
      grepl("positive", CSF_ECSH_1, ignore.case = TRUE),
      1, 0
    )
  )


ecoli_detected <- Tac_filtered %>%
  group_by(age_group) %>%
  summarise(Ecoli_Detected_Deaths = sum(Ecoli_detected, na.rm = TRUE), .groups = 'drop')

# Merge and calculate percentages 
age_group_summary <- total_deaths_by_age %>%
  left_join(ecoli_cases_by_age, by = "age_group") %>%
  left_join(ecoli_detected, by = "age_group") %>%
  mutate(
    Ecoli_Cases_ch = replace_na(Ecoli_Cases_ch, 0),
    Ecoli_Detected_Deaths = replace_na(Ecoli_Detected_Deaths, 0),
    Percentage_Ecoli = (Ecoli_Cases_ch / Total_Deaths) * 100,
    Ecoli_Cases_Combined = paste0(
      Ecoli_Cases_ch, " (", round(Percentage_Ecoli, 2), "%)"
    )
  ) %>%
  select(
    age_group,
    Total_Deaths,
    Ecoli_Detected_Deaths,
    Ecoli_Cases_Combined
  )

 
age_group_summary <- age_group_summary %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Stillbirth",
        "Death in the first 24 hours",
        "Early Neonate (1 to 6 days)",
        "Late Neonate (7 to 27 days)",
        "Infant (28 days to less than 12 months)",
        "Child (12 months to less than 60 months)"
      )
    )
  ) %>%
  arrange(age_group)


total_row <- age_group_summary %>%
  summarise(
    age_group = "Total",
    Total_Deaths = sum(Total_Deaths, na.rm = TRUE),
    Ecoli_Detected_Deaths = sum(Ecoli_Detected_Deaths, na.rm = TRUE),
    Ecoli_Cases_Combined = paste0(
      sum(as.numeric(str_extract(Ecoli_Cases_Combined, "^[0-9]+")), na.rm = TRUE), 
      " (",
      round(sum(as.numeric(str_extract(Ecoli_Cases_Combined, "(?<=\\().+(?=%\\))")), na.rm = TRUE) / nrow(age_group_summary), 2),
      "%)"
    ))


```

```{r Table1, echo= FALSE}
final_summary <- bind_rows(age_group_summary, total_row)

final_summary %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *E. coli* Deaths by Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Total_Deaths = "Total Deaths",
    Ecoli_Detected_Deaths = md("*E. coli* Detected Deaths"),
    Ecoli_Cases_Combined = md("*E. coli* Cases (Causal Chain) %")
  ) %>%
  tab_style(
    style = cell_fill(color = "darkseagreen"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body(rows = nrow(final_summary))
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```


```{r include=FALSE, warning = FALSE}
# Task 4 E. coli #

# Compute total population per location
location_data <- tibble(
  Location = locations,
  Total_People = sapply(locations, function(loc) sum(AnalyticData_E$site_name == loc, na.rm = TRUE))
)


location_labels <- sapply(1:nrow(location_data), function(i) {
  glue("{location_data$Location[i]} (n={location_data$Total_People[i]})")
})
names(location_labels) <- location_data$Location


age_groups <- unique(AnalyticData_E$age_group)

# Compute total people per age group
age_group_data <- tibble(
  Age_Group = age_groups,
  Total_People = sapply(age_groups, function(ag) sum(AnalyticData_E$age_group == ag, na.rm = TRUE))
)

# Filter valid vars_eti
vars_eti_valid <- vars_eti[vars_eti %in% colnames(AnalyticData_E)]


search_matrix <- AnalyticData_E[, vars_eti_valid]


ecoli_flag <- apply(search_matrix, 1, function(row) {
  any(grepl("Escherichia coli", row, ignore.case = TRUE))
})

# Filter E. coli cases
ecoli_cases <- AnalyticData_E %>%
  filter(ecoli_flag) %>%
  select(site_name, age_group) %>%
  filter(site_name %in% location_data$Location)

# Count cases by site and age group
ecoli_counts <- ecoli_cases %>%
  count(site_name, age_group, name = "Ecoli_Cases")


ecoli_table <- ecoli_counts %>%
  pivot_wider(names_from = site_name, values_from = Ecoli_Cases, values_fill = list(Ecoli_Cases = 0)) %>%
  mutate(across(all_of(locations), as.numeric))

# Compute Total (Row %)
ecoli_table <- ecoli_table %>%
  rowwise() %>%
  mutate(
    Total_cases = sum(c_across(all_of(locations)), na.rm = TRUE),
    Age_Group_Population = age_group_data %>%
      filter(Age_Group == age_group) %>%
      pull(Total_People),
    `Total (Row %)` = glue("{Total_cases} ({round((Total_cases / Age_Group_Population) * 100, 1)}%)")
  ) %>%
  ungroup() %>%
  select(-Age_Group_Population, -Total_cases)

# Compute site totals
site_totals <- ecoli_table %>%
  summarise(across(all_of(locations), ~ sum(.x, na.rm = TRUE)))

# Create TOTAL row
total_row <- site_totals %>%
  mutate(age_group = "TOTAL")

for (loc in locations) {
  site_total <- as.numeric(total_row[[loc]])
  population <- location_data %>% filter(Location == loc) %>% pull(Total_People)
  total_row[[loc]] <- glue("{site_total} ({round((site_total / population) * 100, 1)}%)")
}

total_row <- total_row %>%
  mutate(`Total (Row %)` = glue("{sum(as.numeric(unlist(site_totals)), na.rm = TRUE)} ({round(sum(as.numeric(unlist(site_totals)), na.rm = TRUE) / sum(location_data$Total_People) * 100, 1)}%)"))


ecoli_table <- ecoli_table %>%
  mutate(across(all_of(locations), as.character)) %>%
  bind_rows(total_row) %>%
  filter(!is.na(age_group))


age_group_order <- c(
  "Stillbirth",
  "Death in the first 24 hours",
  "Early Neonate (1 to 6 days)",
  "Late Neonate (7 to 27 days)",
  "Infant (28 days to less than 12 months)",
  "Child (12 months to less than 60 months)",
  "TOTAL"
)

# Sort rows
ecoli_table <- ecoli_table %>%
  mutate(
    raw_age_group = case_when(
      age_group == "TOTAL" ~ "TOTAL",
      TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
    ),
    raw_age_group = factor(raw_age_group, levels = age_group_order)
  ) %>%
  arrange(raw_age_group) %>%
  select(-raw_age_group)

# Age group population
age_group_totals <- AnalyticData_E %>%
  group_by(age_group) %>%
  summarise(total_people_age_group = n(), .groups = "drop")

# Add totals to labels
ecoli_table <- ecoli_table %>%
  mutate(raw_age_group = case_when(
    age_group == "TOTAL" ~ "TOTAL",
    TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
  )) %>%
  left_join(age_group_totals, by = c("raw_age_group" = "age_group")) %>%
  mutate(
    age_group = ifelse(
      raw_age_group == "TOTAL",
      "TOTAL",
      glue("{raw_age_group} (n={total_people_age_group})")
    )
  ) %>%
  select(-raw_age_group, -total_people_age_group)


colnames(ecoli_table) <- c("Age Group", location_labels, "Total (Row %)")



```

```{r table2, echo=FALSE}
gt_table <- ecoli_table %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *E. coli* Cases by Age Group and Location**")
  ) %>%
  tab_style(
    style = cell_fill(color = "darkseagreen"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )

# Show the table
gt_table

```


```{r e_coli_infectious_death, include=FALSE, warning = FALSE}

# Identify if each case has an infectious cause
AnalyticData_E <- AnalyticData_E %>%
  mutate(
    Infectious_Cause = ifelse(
      IC_champs_group_desc %in% infectious_causes | UC_champs_group_desc %in% infectious_causes, 1, 0
    )
  )


AnalyticData_E <- AnalyticData_E %>%
  mutate(
    Ec_Causal_Chain = ifelse(
      apply(select(., all_of(vars_eti)), 1, function(row) any(grepl("Escherichia coli", row, ignore.case = TRUE))),
      1, 0
    )
  )

# Summarize by Neonatal Age Group
summary_table <- AnalyticData_E %>%
  group_by(Neonatal_Age_Group) %>%
  summarise(
    total_deaths = n(),
    infectious_cases = sum(Infectious_Cause, na.rm = TRUE),
    ec_cases = sum(Ec_Causal_Chain * Infectious_Cause, na.rm = TRUE)
  ) %>%
  mutate(
    infectious_percent = ifelse(total_deaths > 0, round((infectious_cases / total_deaths) * 100), 0),
    ec_percent = ifelse(infectious_cases > 0, round((ec_cases / infectious_cases) * 100), 0)
  ) %>%
  mutate(
    total_deaths = paste0("n=", total_deaths),
    infectious_cases = paste0(infectious_cases, " (", infectious_percent, "%)"),
    ec_cases = ifelse(!is.na(ec_percent), paste0(ec_cases, " (", ec_percent, "%)"), paste0(ec_cases, " (0%)"))
  ) %>%
  filter(!is.na(Neonatal_Age_Group))


```

```{r table3, echo=FALSE}
summary_table %>%
  select(Neonatal_Age_Group, total_deaths, infectious_cases, ec_cases) %>%
  gt() %>%
  cols_label(
    Neonatal_Age_Group = "Neonatal Age Group (n=total MITS DeCoDed)",
    infectious_cases = "Infectious Cause in Chain",
    ec_cases = "E. coli in Causal Chain (% of infectious)"
  ) %>%
  tab_header(
    title = md("**Summary of *E. coli* in Neonatal Infectious Deaths**")
  ) %>%
  tab_style(
    style = cell_fill(color = "darkseagreen"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "honeydew"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```



## ***Acinetobacter baumannii***

```{r Acib_Death, include=FALSE}

#### Task 3 #####

AnalyticData_A <- AnalyticData %>%
  mutate(
    age_group = recode(age_group, !!!age_group_mapping))


acib_cases_ch <- AnalyticData_A %>%
  filter(apply(AnalyticData_A[vars_eti], 1, function(row) any(grepl("Acinetobacter baumannii", row, ignore.case = TRUE))))

# Calculate the total number of deaths for each age group
total_deaths_by_age <- AnalyticData_A %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n(), .groups = 'drop')


acib_cases_by_age <- AnalyticData_A %>%
  group_by(age_group) %>%
  summarise(Acib_Cases_ch = n(), .groups = 'drop')

# Rename and join TacData with age groups
TacData_A <- TacData %>%
  rename(Champsid = Champsid)

Tac_filtered <- TacData_A %>%
  filter(Champsid %in% AnalyticData_A$Champsid) %>%
  left_join(select(AnalyticData_A, Champsid, age_group), by = "Champsid") %>%
  mutate(
    Acib_detected = ifelse(bld_ABAU_1 == "Positive" | CSF_ABAU_1 == "Positive" | lung_ABAU_1 == "Positive", 1, 0))


Acib_detected <- Tac_filtered %>%
  group_by(age_group) %>%
  summarise(Acib_Detected_Deaths = sum(Acib_detected, na.rm = TRUE), .groups = 'drop')

# Merge summaries and calculate percentages
age_group_summary <- total_deaths_by_age %>%
  left_join(acib_cases_by_age, by = "age_group") %>%
  left_join(Acib_detected, by = "age_group") %>%
  mutate(
    Acib_Cases_ch = replace_na(Acib_Cases_ch, 0),
    Acib_Detected_Deaths = replace_na(Acib_Detected_Deaths, 0),
    Percentage_Staph = (Acib_Cases_ch / Total_Deaths) * 100
  )

# Combine Cases and Percentages into a single column
age_group_summary <- age_group_summary %>%
  mutate(
    Acib_Cases_Combined = paste0(
      Acib_Cases_ch, " (", round(Percentage_Staph, 2), "%)"
    )
  ) %>%
  select(
    age_group,
    Total_Deaths,
    Acib_Detected_Deaths,
    Acib_Cases_Combined
  )

# Arrange by age group order
age_group_summary <- age_group_summary %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Stillbirth",
        "Death in the first 24 hours",
        "Early Neonate (1 to 6 days)",
        "Late Neonate (7 to 27 days)",
        "Infant (28 days to less than 12 months)",
        "Child (12 months to less than 60 months)"
      )
    )
  ) %>%
  arrange(age_group)

# Calculate the total row
total_row <- age_group_summary %>%
  summarise(
    age_group = "Total",  # Label the total row
    Total_Deaths = sum(Total_Deaths, na.rm = TRUE),
    Acib_Detected_Deaths = sum(Acib_Detected_Deaths, na.rm = TRUE),
    Acib_Cases_Combined = paste0(
      sum(as.numeric(str_extract(Acib_Cases_Combined, "^[0-9]+")), na.rm = TRUE), 
      " (",
      round(sum(as.numeric(str_extract(Acib_Cases_Combined, "(?<=\\().+(?=%\\))")), na.rm = TRUE) / nrow(age_group_summary), 2), 
      "%)"
    )
  )


final_summary <- bind_rows(age_group_summary, total_row)



```

```{r acib_Death_graph, echo=FALSE}

final_summary %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *A. baumanii* Deaths by Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Total_Deaths = "Total Deaths",
    Acib_Detected_Deaths = md("*A. baumanii * Detected Deaths"),
    Acib_Cases_Combined = md("*A. baumanii * Cases (Causal Chain) %")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightcoral"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "pink"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "pink"),
    locations = cells_body(rows = nrow(final_summary))  # Highlight the total row
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )
```


```{r include=FALSE, warning = FALSE}
# Task 4

acib_flag <- apply(search_matrix, 1, function(row) {
  any(grepl("Acinetobacter baumannii", row, ignore.case = TRUE))
})


acib_cases <- AnalyticData_A %>%
  filter(acib_flag) %>%
  select(site_name, age_group) %>%
  filter(site_name %in% location_data$Location)

acib_counts <- acib_cases %>%
  count(site_name, age_group, name = "Acinetobacter_Cases")


acib_table <- acib_counts %>%
  pivot_wider(names_from = site_name, values_from = Acinetobacter_Cases, values_fill = list(Acinetobacter_Cases = 0))


acib_table <- acib_table %>%
  mutate(across(all_of(locations), as.numeric))

# Compute Total (Row %)
acib_table <- acib_table %>%
  rowwise() %>%
  mutate(
    Total_cases = sum(c_across(all_of(locations)), na.rm = TRUE),
    Age_Group_Population = age_group_data %>% 
      filter(Age_Group == age_group) %>% 
      pull(Total_People),
    `Total (Row %)` = glue("{Total_cases} ({round((Total_cases / Age_Group_Population) * 100, 1)}%)")
  ) %>%
  ungroup() %>%
  select(-Age_Group_Population, -Total_cases)

# Compute site totals
site_totals <- acib_table %>%
  summarise(across(all_of(locations), ~ sum(.x, na.rm = TRUE)))

# Create TOTAL row
total_row <- site_totals %>%
  mutate(age_group = "TOTAL")


for (loc in locations) {
  site_total <- as.numeric(total_row[[loc]])
  population <- location_data %>% filter(Location == loc) %>% pull(Total_People)
  total_row[[loc]] <- glue("{site_total} ({round((site_total / population) * 100, 1)}%)")
}

# Format TOTAL (Row %) column
total_row <- total_row %>%
  mutate(`Total (Row %)` = glue("{sum(as.numeric(unlist(site_totals)), na.rm = TRUE)} ({round(sum(as.numeric(unlist(site_totals)), na.rm = TRUE) / sum(location_data$Total_People) * 100, 1)}%)"))


acib_table <- acib_table %>%
  mutate(across(all_of(locations), as.character))


final_table <- acib_table %>%
  bind_rows(total_row) %>%
  filter(!is.na(age_group))


age_group_order <- c(
  "Stillbirth",
  "Death in the first 24 hours",
  "Early Neonate (1 to 6 days)",
  "Late Neonate (7 to 27 days)",
  "Infant (28 days to less than 12 months)",
  "Child (12 months to less than 60 months)",
  "TOTAL"
)

# Extract raw age group names for sorting
final_table <- final_table %>%
  mutate(
    raw_age_group = case_when(
      age_group == "TOTAL" ~ "TOTAL",
      TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
    ),
    raw_age_group = factor(raw_age_group, levels = age_group_order)
  ) %>%
  arrange(raw_age_group) %>%
  select(-raw_age_group)

age_group_totals <- AnalyticData_A %>%
  group_by(age_group) %>%
  summarise(total_people_age_group = n(), .groups = "drop")

# Add age group totals to final_table using the raw age group name
final_table <- final_table %>%
  mutate(raw_age_group = case_when(
    age_group == "TOTAL" ~ "TOTAL",
    TRUE ~ gsub(" \\(n=.*\\)", "", age_group) 
  )) %>%
  left_join(age_group_totals, by = c("raw_age_group" = "age_group")) %>%
  mutate(
    age_group = ifelse(
      raw_age_group == "TOTAL",
      "TOTAL",
      glue("{raw_age_group} (n={total_people_age_group})")
    )
  ) %>%
  select(-raw_age_group, -total_people_age_group)


colnames(final_table) <- c("Age Group", location_labels, "Total (Row %)")

```

```{r Atable2, echo=FALSE}

gt_table <- final_table %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *A. baumannii* Cases by Age Group and Location**")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightcoral"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "pink"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )

# Show the table
gt_table


```



```{r include=FALSE, warning = FALSE}

AnalyticData_A <- AnalyticData_A %>%
  mutate(
    calc_dob = ymd(calc_dob),  
    calc_dod = ymd(calc_dod)   
  )


AnalyticData_A <- AnalyticData_A %>%
  mutate(age_in_days = as.numeric(difftime(calc_dod, calc_dob, units = "days")))

# Create the `month_old` column
AnalyticData_A1 <- AnalyticData_A %>%
  mutate(
    month_old = case_when(
      case_type_calc == "CH00718" & age_in_days >= 28 & age_in_days < 60 ~ "28d to <2 months",
      case_type_calc == "CH00718" & age_in_days >= 60 & age_in_days < 90 ~ "2 to <3 months",
      case_type_calc == "CH00718" & age_in_days >= 90 & age_in_days < 120 ~ "3 to <4 months",
      case_type_calc == "CH00718" & age_in_days >= 120 & age_in_days < 150 ~ "4 to <5 months",
      case_type_calc == "CH00718" & age_in_days >= 150 & age_in_days < 180 ~ "5 to <6 months",
      TRUE ~ NA_character_  # Keep other age groups unchanged
    )
  )

# Filter or retain rows where `month_old` is not NA
AnalyticData_A1 <- AnalyticData_A1 %>%
  filter(!is.na(month_old))  



print(AnalyticData_A1$month_old)
```


```{r include=FALSE, warning = FALSE}


month_totals <- AnalyticData_A1 %>%
  filter(!is.na(month_old)) %>%
  group_by(month_old) %>%
  summarise(Total_people = n()) %>%
  mutate(
    month_old = factor(month_old, levels = c(
      "28d to <2 months",
      "2 to <3 months",
      "3 to <4 months",
      "4 to <5 months",
      "5 to <6 months"
    ))
  )

print(month_totals)

# Filter A. baumannii causal chain cases
ab_cases_ch <- AnalyticData_A1 %>%
  filter(!is.na(month_old)) %>%
  filter(apply(select(., all_of(vars_eti)), 1, function(row) any(grepl("Acinetobacter baumannii", row, ignore.case = TRUE)))) %>%
  group_by(month_old) %>%
  summarise(A_baumannii_ch = n()) %>%
  left_join(month_totals, by = "month_old") %>%
  mutate(
    Percent = round((A_baumannii_ch / Total_people) * 100, 1),
    `A_baumannii_ch (%)` = paste0(A_baumannii_ch, " (", Percent, "%)")
  )


TacData_A <- TacData %>%
  rename(ChampsID = Champsid)

TacData_A <- TacData_A %>%
  filter(Champsid %in% AnalyticData_A$Champsid) %>%
  left_join(select(AnalyticData_A, Champsid, month_old), by = "Champsid") %>%
  filter(!is.na(month_old)) %>%
  mutate(
    A_baumannii_detected = ifelse(
      bld_ACBA_1 == "Positive" | CSF_ACBA_1 == "Positive" | lung_ACBA_1 == "Positive", 1, 0
    )
  )

# TAC detection summary
ab_tac_summary <- TacData_A %>%
  filter(A_baumannii_detected == 1) %>%
  group_by(month_old) %>%
  summarise(A_baumannii_TAC = n()) %>%
  left_join(month_totals, by = "month_old") %>%
  mutate(
    TAC_Percent = round((A_baumannii_TAC / Total_people) * 100, 1),
    `A_baumannii_in_TAC` = paste0(A_baumannii_TAC, " (", TAC_Percent, "%)")
  )

# Combine summaries
ab_combined <- ab_tac_summary %>%
  left_join(ab_cases_ch, by = "month_old") %>%
  mutate(
    month_old_label = case_when(
      month_old == "28d to <2 months" ~ "28d to <2 months (n=178)",
      month_old == "2 to <3 months" ~ "2 to <3 months (n=106)",
      month_old == "3 to <4 months" ~ "3 to <4 months (n=82)",
      month_old == "4 to <5 months" ~ "4 to <5 months (n=61)",
      month_old == "5 to <6 months" ~ "5 to <6 months (n=73)"
    )
  ) %>%
  arrange(factor(month_old, levels = c(
    "28d to <2 months",
    "2 to <3 months",
    "3 to <4 months",
    "4 to <5 months",
    "5 to <6 months"
  ))) %>%
  select(
    month_old_label,
    `A_baumannii_in_TAC`,
    `A_baumannii_ch (%)`
  ) %>%
  filter(!is.na(month_old_label))

```

```{r Atable3, echo=FALSE}

ab_combined %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *A. baumannii* in Causal Chain and TAC by Month Old**")
  ) %>%
  cols_label(
    month_old_label = "Month Old",
    `A_baumannii_ch (%)` = md("*A. baumannii* in Causal Chain (%)"),
    `A_baumannii_in_TAC` = md("*A. baumannii* in TAC (%)")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightcoral"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "pink"),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )

```



```{r aci_infecious, include=FALSE, warning = FALSE}

# Identify if each case has an infectious cause
AnalyticData_A <- AnalyticData_A %>%
  mutate(
    Infectious_Cause = ifelse(
      IC_champs_group_desc %in% infectious_causes | UC_champs_group_desc %in% infectious_causes, 1, 0
    )
  )

AnalyticData_A <- AnalyticData_A %>%
  mutate(
    Acinetobacter_Causal_Chain = ifelse(
      apply(select(., all_of(vars_eti)), 1, function(row) any(grepl("Acinetobacter baumannii", row, ignore.case = TRUE))),1, 0))

summary_table <- AnalyticData_A %>%
  group_by(Neonatal_Age_Group) %>%
  summarise(
    total_deaths = n(),
    infectious_cases = sum(Infectious_Cause, na.rm = TRUE), # Count of deaths with infectious causes
    acinetobacter_cases = sum(Acinetobacter_Causal_Chain * Infectious_Cause, na.rm = TRUE) # Count of Acinetobacter baumannii cases among infectious deaths
  ) %>%
  mutate(
    infectious_percent = ifelse(total_deaths > 0, round((infectious_cases / total_deaths) * 100), 0),
    acinetobacter_percent = ifelse(infectious_cases > 0, round((acinetobacter_cases / infectious_cases) * 100), 0)
  ) %>%
  mutate(
    total_deaths = paste0("n=", total_deaths),
    infectious_cases = paste0(infectious_cases, " (", infectious_percent, "%)"),
    acinetobacter_cases = ifelse(!is.na(acinetobacter_percent), paste0(acinetobacter_cases, " (", acinetobacter_percent, "%)"), paste0(acinetobacter_cases, " (0%)"))
  ) %>%
  filter(!is.na(Neonatal_Age_Group))


```

```{r Atable4, echo=FALSE}

summary_table %>%
  select(Neonatal_Age_Group, total_deaths, infectious_cases, acinetobacter_cases) %>%
  gt() %>%
  cols_label(
    Neonatal_Age_Group = "Neonatal Age Group (n=total MITS DeCoDed)",
    infectious_cases = "Infectious Cause in Chain",
    acinetobacter_cases = md("*A. baumannii* in Causal Chain (% of infectious)")
  ) %>%
  tab_header(
    title = md("**Summary of *A. baumannii* Neonatal Infectious Deaths**")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightcoral"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "pink"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )
```



## ***Pseudomonas aeruginosa***

```{r Pse, include=FALSE, warning = FALSE}
AnalyticData_P <- AnalyticData %>%
  mutate(
    age_group = recode(age_group, !!!age_group_mapping))

# Filter Pseudomonas aeruginosa cases in the causal chain
psae_cases_ch <- AnalyticData_P %>%
  filter(apply(AnalyticData_P[vars_eti], 1, function(row) any(grepl("Pseudomonas aeruginosa", row, ignore.case = TRUE))))

# Calculate total deaths by age group
total_deaths_by_age <- AnalyticData_P %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n(), .groups = 'drop')

# Count Pseudomonas cases in causal chain
psae_cases_by_age <- psae_cases_ch %>%
  group_by(age_group) %>%
  summarise(PSAE_Cases_ch = n(), .groups = 'drop')

# Prepare TAC detection
TacData_P <- TacData %>%
  rename(Champsid = Champsid)

Tac_filtered <- TacData_P %>%
  filter(Champsid %in% AnalyticData_P$Champsid) %>%
  left_join(select(AnalyticData_P, Champsid, age_group), by = "Champsid") %>%
  mutate(
    psae_detected = ifelse(bld_PSAE_1 == "Positive" | CSF_PSAE_1 == "Positive" | lung_PSAE_1 == "Positive", 1, 0)
  )

# Summarize detected Pseudomonas deaths
psae_detected <- Tac_filtered %>%
  group_by(age_group) %>%
  summarise(PSAE_Detected_Deaths = sum(psae_detected, na.rm = TRUE), .groups = 'drop')

# Combine summaries
age_group_summary <- total_deaths_by_age %>%
  left_join(psae_cases_by_age, by = "age_group") %>%
  left_join(psae_detected, by = "age_group") %>%
  mutate(
    PSAE_Cases_ch = replace_na(PSAE_Cases_ch, 0),
    PSAE_Detected_Deaths = replace_na(PSAE_Detected_Deaths, 0),
    Percentage_PSAE = (PSAE_Cases_ch / Total_Deaths) * 100
  )

# Combine for display
age_group_summary <- age_group_summary %>%
  mutate(
    PSAE_Cases_Combined = paste0(
      PSAE_Cases_ch, " (", round(Percentage_PSAE, 2), "%)"
    )
  ) %>%
  select(
    age_group,
    Total_Deaths,
    PSAE_Detected_Deaths,
    PSAE_Cases_Combined
  )

# Order rows
age_group_summary <- age_group_summary %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Stillbirth",
        "Death in the first 24 hours",
        "Early Neonate (1 to 6 days)",
        "Late Neonate (7 to 27 days)",
        "Infant (28 days to less than 12 months)",
        "Child (12 months to less than 60 months)"
      )
    )
  ) %>%
  arrange(age_group)

# Total row
total_row <- age_group_summary %>%
  summarise(
    age_group = "Total",
    Total_Deaths = sum(Total_Deaths, na.rm = TRUE),
    PSAE_Detected_Deaths = sum(PSAE_Detected_Deaths, na.rm = TRUE),
    PSAE_Cases_Combined = paste0(
      sum(as.numeric(str_extract(PSAE_Cases_Combined, "^[0-9]+")), na.rm = TRUE),
      " (",
      round(sum(as.numeric(str_extract(PSAE_Cases_Combined, "(?<=\\().+(?=%\\))")), na.rm = TRUE) / nrow(age_group_summary), 2),
      "%)"
    )
  )

final_summary <- bind_rows(age_group_summary, total_row)

```

```{r Ptable1, echo=FALSE}
final_summary %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *P. aeruginosa* Deaths by Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Total_Deaths = "Total Deaths",
    PSAE_Detected_Deaths = md("*P. aeruginosa* Detected Deaths"),
    PSAE_Cases_Combined = md("*P. aeruginosa* Cases (Causal Chain) %")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightblue"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "aliceblue"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "aliceblue"),
    locations = cells_body(rows = nrow(final_summary))
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```


```{r include=FALSE, warning = FALSE}

# Compute total population per location
location_data <- tibble(
  Location = locations,
  Total_People = sapply(locations, function(loc) sum(AnalyticData_P$site_name == loc, na.rm = TRUE))
)


location_labels <- sapply(1:nrow(location_data), function(i) {
  glue("{location_data$Location[i]} (n={location_data$Total_People[i]})")
})
names(location_labels) <- location_data$Location


age_groups <- unique(AnalyticData_P$age_group)

# Compute total people per age group
age_group_data <- tibble(
  Age_Group = age_groups,
  Total_People = sapply(age_groups, function(ag) sum(AnalyticData_P$age_group == ag, na.rm = TRUE))
)


vars_eti_valid <- vars_eti[vars_eti %in% colnames(AnalyticData_P)]
search_matrix <- AnalyticData_P[, vars_eti_valid]


psae_flag <- apply(search_matrix, 1, function(row) {
  any(grepl("Pseudomonas aeruginosa", row, ignore.case = TRUE))
})

# Filter Pseudomonas cases
psae_cases <- AnalyticData_P %>%
  filter(psae_flag) %>%
  select(site_name, age_group) %>%
  filter(site_name %in% location_data$Location)


psae_counts <- psae_cases %>%
  count(site_name, age_group, name = "Psae_Cases")


psae_table <- psae_counts %>%
  pivot_wider(names_from = site_name, values_from = Psae_Cases, values_fill = list(Psae_Cases = 0)) %>%
  mutate(across(all_of(locations), as.numeric))

# Compute total per row
psae_table <- psae_table %>%
  rowwise() %>%
  mutate(
    Total_cases = sum(c_across(all_of(locations)), na.rm = TRUE),
    Age_Group_Population = age_group_data %>%
      filter(Age_Group == age_group) %>%
      pull(Total_People),
    `Total (Row %)` = glue("{Total_cases} ({round((Total_cases / Age_Group_Population) * 100, 1)}%)")
  ) %>%
  ungroup() %>%
  select(-Age_Group_Population, -Total_cases)

# Compute site totals
site_totals <- psae_table %>%
  summarise(across(all_of(locations), ~ sum(.x, na.rm = TRUE)))

# Create total row
total_row <- site_totals %>%
  mutate(age_group = "TOTAL")

for (loc in locations) {
  site_total <- as.numeric(total_row[[loc]])
  population <- location_data %>% filter(Location == loc) %>% pull(Total_People)
  total_row[[loc]] <- glue("{site_total} ({round((site_total / population) * 100, 1)}%)")
}

total_row <- total_row %>%
  mutate(`Total (Row %)` = glue("{sum(as.numeric(unlist(site_totals)), na.rm = TRUE)} ({round(sum(as.numeric(unlist(site_totals)), na.rm = TRUE) / sum(location_data$Total_People) * 100, 1)}%)"))


psae_table <- psae_table %>%
  mutate(across(all_of(locations), as.character)) %>%
  bind_rows(total_row) %>%
  filter(!is.na(age_group))


age_group_order <- c(
  "Stillbirth",
  "Death in the first 24 hours",
  "Early Neonate (1 to 6 days)",
  "Late Neonate (7 to 27 days)",
  "Infant (28 days to less than 12 months)",
  "Child (12 months to less than 60 months)",
  "TOTAL"
)

psae_table <- psae_table %>%
  mutate(
    raw_age_group = case_when(
      age_group == "TOTAL" ~ "TOTAL",
      TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
    ),
    raw_age_group = factor(raw_age_group, levels = age_group_order)
  ) %>%
  arrange(raw_age_group) %>%
  select(-raw_age_group)

# Get total population per age group
age_group_totals <- AnalyticData_P %>%
  group_by(age_group) %>%
  summarise(total_people_age_group = n(), .groups = "drop")

# Add population
final_table <- psae_table %>%
  mutate(raw_age_group = case_when(
    age_group == "TOTAL" ~ "TOTAL",
    TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
  )) %>%
  left_join(age_group_totals, by = c("raw_age_group" = "age_group")) %>%
  mutate(
    age_group = ifelse(
      raw_age_group == "TOTAL",
      "TOTAL",
      glue("{raw_age_group} (n={total_people_age_group})")
    )
  ) %>%
  select(-raw_age_group, -total_people_age_group)


colnames(final_table) <- c("Age Group", location_labels, "Total (Row %)")

```

```{r Ptable2, echo=FALSE}

gt_table <- final_table %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *Pseudomonas aeruginosa* Cases by Age Group and Location**")
  ) %>%
  tab_style(
    style = cell_fill(color = "lightblue"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "aliceblue"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )


gt_table

```



## ***Streptococcus pneumoniae***

```{r s_p, include=FALSE, warning = FALSE}

AnalyticData_SE <- AnalyticData %>%
  mutate(
    age_group = recode(age_group, !!!age_group_mapping))

sts_cases_ch <- AnalyticData_SE %>%
  filter(apply(AnalyticData_SE[vars_eti], 1, function(row) any(grepl("Streptococcus suis", row, ignore.case = TRUE))))

# Total deaths by age group
total_deaths_by_age <- AnalyticData_SE %>%
  group_by(age_group) %>%
  summarise(Total_Deaths = n(), .groups = 'drop')

# Causal chain cases
sts_cases_by_age <- sts_cases_ch %>%
  group_by(age_group) %>%
  summarise(STS_Cases_ch = n(), .groups = 'drop')


TacData_SE <- TacData %>%
  rename(ChampsID = Champsid)

Tac_filtered <- TacData_SE %>%
  filter(Champsid %in% AnalyticData_SE$Champsid) %>%
  left_join(select(AnalyticData_SE, Champsid, age_group), by = "Champsid") %>%
  mutate(
    sts_detected = ifelse(bld_STPN_2 == "Positive" | CSF_STPN_2 == "Positive" | lung_STPN_2 == "Positive", 1, 0)
  )

sts_detected <- Tac_filtered %>%
  group_by(age_group) %>%
  summarise(STS_Detected_Deaths = sum(sts_detected, na.rm = TRUE), .groups = 'drop')

# Merge and calculate percentage
age_group_summary <- total_deaths_by_age %>%
  left_join(sts_cases_by_age, by = "age_group") %>%
  left_join(sts_detected, by = "age_group") %>%
  mutate(
    STS_Cases_ch = replace_na(STS_Cases_ch, 0),
    STS_Detected_Deaths = replace_na(STS_Detected_Deaths, 0),
    Percentage_STS = (STS_Cases_ch / Total_Deaths) * 100
  )


age_group_summary <- age_group_summary %>%
  mutate(
    STS_Cases_Combined = paste0(
      STS_Cases_ch, " (", round(Percentage_STS, 2), "%)"
    )
  ) %>%
  select(
    age_group,
    Total_Deaths,
    STS_Detected_Deaths,
    STS_Cases_Combined
  )


age_group_summary <- age_group_summary %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Stillbirth",
        "Death in the first 24 hours",
        "Early Neonate (1 to 6 days)",
        "Late Neonate (7 to 27 days)",
        "Infant (28 days to less than 12 months)",
        "Child (12 months to less than 60 months)"
      )
    )
  ) %>%
  arrange(age_group)

# Total row
total_row <- age_group_summary %>%
  summarise(
    age_group = "Total",
    Total_Deaths = sum(Total_Deaths, na.rm = TRUE),
    STS_Detected_Deaths = sum(STS_Detected_Deaths, na.rm = TRUE),
    STS_Cases_Combined = paste0(
      sum(as.numeric(str_extract(STS_Cases_Combined, "^[0-9]+")), na.rm = TRUE),
      " (",
      round(sum(as.numeric(str_extract(STS_Cases_Combined, "(?<=\\().+(?=%\\))")), na.rm = TRUE) / nrow(age_group_summary), 2),
      "%)"
    )
  )

final_summary <- bind_rows(age_group_summary, total_row)

```

```{r SPtable1, echo=FALSE}
final_summary %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *S. pneumoniae* Deaths by Age Group**")
  ) %>%
  cols_label(
    age_group = "Age Group",
    Total_Deaths = "Total Deaths",
    STS_Detected_Deaths = md("*S. pneumoniae* Detected Deaths"),
    STS_Cases_Combined = md("*S. pneumoniae* Cases (Causal Chain) %")
  ) %>%
  tab_style(
    style = cell_fill(color = "cornflowerblue"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lightsteelblue"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_fill(color = "lightsteelblue"),
    locations = cells_body(rows = nrow(final_summary))
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```


```{r s_P-_loc, include=FALSE, warning = FALSE}

# Compute total population per location
location_data <- tibble(
  Location = locations,
  Total_People = sapply(locations, function(loc) sum(AnalyticData_SE$site_name == loc, na.rm = TRUE))
)

# Create labeled column names
location_labels <- sapply(1:nrow(location_data), function(i) {
  glue("{location_data$Location[i]} (n={location_data$Total_People[i]})")
})
names(location_labels) <- location_data$Location


age_groups <- unique(AnalyticData_SE$age_group)

# Total people per age group
age_group_data <- tibble(
  Age_Group = age_groups,
  Total_People = sapply(age_groups, function(ag) sum(AnalyticData_SE$age_group == ag, na.rm = TRUE))
)


vars_eti_valid <- vars_eti[vars_eti %in% colnames(AnalyticData_SE)]

search_matrix <- AnalyticData[, vars_eti_valid]


spn_flag <- apply(search_matrix, 1, function(row) {
  any(grepl("Streptococcus pneumoniae", row, ignore.case = TRUE))
})


spn_cases <- AnalyticData_SE %>%
  filter(spn_flag) %>%
  select(site_name, age_group) %>%
  filter(site_name %in% location_data$Location)

# Count SPN cases by site and age group
spn_counts <- spn_cases %>%
  count(site_name, age_group, name = "SPN_Cases")


spn_table <- spn_counts %>%
  pivot_wider(names_from = site_name, values_from = SPN_Cases, values_fill = list(SPN_Cases = 0)) %>%
  mutate(across(all_of(locations), as.numeric))

# Compute totals and row % per age group
spn_table <- spn_table %>%
  rowwise() %>%
  mutate(
    Total_cases = sum(c_across(all_of(locations)), na.rm = TRUE),
    Age_Group_Population = age_group_data %>% filter(Age_Group == age_group) %>% pull(Total_People),
    `Total (Row %)` = glue("{Total_cases} ({round((Total_cases / Age_Group_Population) * 100, 1)}%)")
  ) %>%
  ungroup() %>%
  select(-Age_Group_Population, -Total_cases)

# Compute site column totals
site_totals <- spn_table %>%
  summarise(across(all_of(locations), ~ sum(.x, na.rm = TRUE)))


total_row <- site_totals %>%
  mutate(age_group = "TOTAL")

for (loc in locations) {
  site_total <- as.numeric(total_row[[loc]])
  population <- location_data %>% filter(Location == loc) %>% pull(Total_People)
  total_row[[loc]] <- glue("{site_total} ({round((site_total / population) * 100, 1)}%)")
}

# Add total (row %) for TOTAL row
total_row <- total_row %>%
  mutate(`Total (Row %)` = glue("{sum(as.numeric(unlist(site_totals)), na.rm = TRUE)} ({round(sum(as.numeric(unlist(site_totals)), na.rm = TRUE) / sum(location_data$Total_People) * 100, 1)}%)"))


spn_table <- spn_table %>%
  mutate(across(all_of(locations), as.character)) %>%
  bind_rows(total_row) %>%
  filter(!is.na(age_group))


age_group_order <- c(
  "Stillbirth",
  "Death in the first 24 hours",
  "Early Neonate (1 to 6 days)",
  "Late Neonate (7 to 27 days)",
  "Infant (28 days to less than 12 months)",
  "Child (12 months to less than 60 months)",
  "TOTAL"
)


spn_table <- spn_table %>%
  mutate(
    raw_age_group = case_when(
      age_group == "TOTAL" ~ "TOTAL",
      TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
    ),
    raw_age_group = factor(raw_age_group, levels = age_group_order)
  ) %>%
  arrange(raw_age_group) %>%
  select(-raw_age_group)


age_group_totals <- AnalyticData_SE %>%
  group_by(age_group) %>%
  summarise(total_people_age_group = n(), .groups = "drop")

spn_table <- spn_table %>%
  mutate(raw_age_group = case_when(
    age_group == "TOTAL" ~ "TOTAL",
    TRUE ~ gsub(" \\(n=.*\\)", "", age_group)
  )) %>%
  left_join(age_group_totals, by = c("raw_age_group" = "age_group")) %>%
  mutate(
    age_group = ifelse(
      raw_age_group == "TOTAL",
      "TOTAL",
      glue("{raw_age_group} (n={total_people_age_group})")
    )
  ) %>%
  select(-raw_age_group, -total_people_age_group)


colnames(spn_table) <- c("Age Group", location_labels, "Total (Row %)")

```

```{r SPtable2, echo=FALSE}
spn_table %>%
  gt() %>%
  tab_header(
    title = md("**Summary of *S. pneumoniae* Cases by Age Group and Location**")
  ) %>%
  tab_style(
    style = cell_fill(color = "cornflowerblue"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lightsteelblue"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.font.size = px(14),
    table.width = pct(100)
  )

```



```{r S_infeciou, include=FALSE, warning = FALSE}

# Identify if each case has an infectious cause
AnalyticData_SE <- AnalyticData_SE %>%
  mutate(
    Infectious_Cause = ifelse(
      IC_champs_group_desc %in% infectious_causes | UC_champs_group_desc %in% infectious_causes, 1, 0
    )
  )

# Identify SPN in the causal chain
AnalyticData_SE <- AnalyticData_SE %>%
  mutate(
    Spn_Causal_Chain = ifelse(
      apply(select(., all_of(vars_eti)), 1, function(row) any(grepl("Streptococcus pneumoniae", row, ignore.case = TRUE))),
      1, 0
    )
  )

# Summarize results by Neonatal Age Group
summary_table <- AnalyticData_SE %>%
  group_by(Neonatal_Age_Group) %>%
  summarise(
    Total_deaths = n(),
    infectious_cases = sum(Infectious_Cause, na.rm = TRUE),
    spn_cases = sum(Spn_Causal_Chain * Infectious_Cause, na.rm = TRUE)
  ) %>%
  mutate(
    infectious_percent = ifelse(Total_deaths > 0, round((infectious_cases / Total_deaths) * 100), 0),
    spn_percent = ifelse(infectious_cases > 0, round((spn_cases / infectious_cases) * 100), 0)
  ) %>%
  mutate(
    Total_deaths = paste0("n=", Total_deaths),
    infectious_cases = paste0(infectious_cases, " (", infectious_percent, "%)"),
    spn_cases = ifelse(!is.na(spn_percent), paste0(spn_cases, " (", spn_percent, "%)"), paste0(spn_cases, " (0%)"))
  ) %>%
  filter(!is.na(Neonatal_Age_Group))

```

```{r SPtable3, echo=FALSE}
summary_table %>%
  select(Neonatal_Age_Group, Total_deaths, infectious_cases, spn_cases) %>%
  gt() %>%
  cols_label(
    Neonatal_Age_Group = "Neonatal Age Group (n=total MITS DeCoDed)",
    infectious_cases = "Infectious Cause in Chain",
    spn_cases = "S. pneumoniae in Causal Chain (% of infectious)"
  ) %>%
  tab_header(
    title = md("**Summary of *S. pneumoniae* in Neonatal Infectious Deaths**")
  ) %>%
  tab_style(
    style = cell_fill(color = "cornflowerblue"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_fill(color = "lightsteelblue"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(14)
  )

```

